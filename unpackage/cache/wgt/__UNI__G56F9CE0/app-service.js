if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((a=>t.resolve(e()).then((()=>a))),(a=>t.resolve(e()).then((()=>{throw a}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...a){uni.__log__?uni.__log__(e,t,...a):console[e].apply(console,[...a,t])}const a=(t,a=0)=>(a,n=e.getCurrentInstance())=>{!e.isInSSRComponentSetup&&e.injectHook(t,a,n)},n=a("onShow",3),o=a("onHide",3),l=a("onLaunch",1),r=a("onLoad",2),i=(e,t)=>{const a=e.__vccOpts||e;for(const[n,o]of t)a[n]=o;return a},s=i({__name:"UserAvatar",props:{name:{type:String,default:""},avatarUrl:{type:String,default:""},avatarColor:{type:String,default:"#3b82f6"},size:{type:Number,default:40}},setup(t){const a=t,n=e.computed((()=>a.name?a.name.trim().charAt(0).toUpperCase():"?"));return(a,o)=>(e.openBlock(),e.createElementBlock("view",{class:"rounded-full flex items-center justify-center overflow-hidden shrink-0",style:e.normalizeStyle({width:t.size+"px",height:t.size+"px",backgroundColor:t.avatarColor||"#e0e0e0",borderRadius:"50%"})},[t.avatarUrl?(e.openBlock(),e.createElementBlock("image",{key:0,src:t.avatarUrl,class:"w-full h-full",mode:"aspectFill"},null,8,["src"])):(e.openBlock(),e.createElementBlock("text",{key:1,class:"text-white font-bold flex items-center justify-center",style:e.normalizeStyle({fontSize:.45*t.size+"px",lineHeight:"1",display:"flex"})},e.toDisplayString(n.value),5))],4))}},[["__scopeId","data-v-b6f3425e"]]),c=e=>{if(!e)return"";const t=Date.now()-e;if(t<6e4)return"Vừa xong";if(t<36e5){return`${Math.floor(t/6e4)} phút trước`}if(t<864e5){return`${Math.floor(t/36e5)} giờ trước`}const a=new Date(e);return`${a.getDate().toString().padStart(2,"0")}/${(a.getMonth()+1).toString().padStart(2,"0")}/${a.getFullYear()} ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`},d=e=>{if(!e)return"";try{if(e.includes("-")){const t=e.split("-");if(3===t.length){const[e,a,n]=t;return`${n}/${a}/${e}`}}return e}catch(t){return e}},u=i(e.defineComponent({__name:"DateRangeFilter",props:{title:{},startDate:{},endDate:{}},emits:["update:startDate","update:endDate"],setup(t,{emit:a}){const n=a,o=e=>{n("update:startDate",e.detail.value)},l=e=>{n("update:endDate",e.detail.value)};return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"date-filter-block"},[t.title?(e.openBlock(),e.createElementBlock("view",{key:0,class:"f-section-title"},e.toDisplayString(t.title),1)):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"f-row"},[e.createElementVNode("view",{class:"f-group half"},[e.createElementVNode("picker",{mode:"date",value:t.startDate,onChange:o},[e.createElementVNode("view",{class:e.normalizeClass(["f-picker date",{placeholder:!t.startDate}])},e.toDisplayString(t.startDate?e.unref(d)(t.startDate):"Từ ngày"),3)],40,["value"])]),e.createElementVNode("view",{class:"f-group half"},[e.createElementVNode("picker",{mode:"date",value:t.endDate,onChange:l},[e.createElementVNode("view",{class:e.normalizeClass(["f-picker date",{placeholder:!t.endDate}])},e.toDisplayString(t.endDate?e.unref(d)(t.endDate):"Đến ngày"),3)],40,["value"])])])]))}}),[["__scopeId","data-v-3823db9a"]]),m=i(e.defineComponent({__name:"CustomerModal",props:{visible:{type:Boolean},customers:{},loading:{type:Boolean}},emits:["close","select"],setup(a,{emit:n}){const o=n,l=e.reactive({name:"",phone:"",managerIndex:0,startDate:"",endDate:""}),r=e.ref(["Thành viên quản lý","Nguyễn Văn A","Trần Thị B"]),i=e=>{l.managerIndex=e.detail.value},c=()=>{l.name="",l.phone="",l.managerIndex=0,l.startDate="",l.endDate="",t("log","at components/Todo/CustomerModal.vue:128","Đã đặt lại bộ lọc")},d=()=>{t("log","at components/Todo/CustomerModal.vue:132","Thực hiện lọc với:",l)},m=()=>{o("close")},p=e=>{if(!e)return"";const t=new Date(e);return`${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`};return(t,a)=>t.visible?(e.openBlock(),e.createElementBlock("view",{key:0,class:"modal-overlay",onClick:e.withModifiers(m,["stop"])},[e.createElementVNode("view",{class:"modal-content",onClick:a[4]||(a[4]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("view",{class:"modal-header"},[e.createElementVNode("text",{class:"modal-title"},"Chọn khách hàng"),e.createElementVNode("text",{class:"close-btn",onClick:m},"✕")]),e.createElementVNode("view",{class:"filter-section"},[e.createElementVNode("view",{class:"f-item"},[e.withDirectives(e.createElementVNode("input",{class:"f-input","onUpdate:modelValue":a[0]||(a[0]=e=>l.name=e),placeholder:"Nhập tên khách hàng","placeholder-class":"ph-style"},null,512),[[e.vModelText,l.name]])]),e.createElementVNode("view",{class:"f-item"},[e.withDirectives(e.createElementVNode("input",{class:"f-input","onUpdate:modelValue":a[1]||(a[1]=e=>l.phone=e),type:"number",placeholder:"Nhập số điện thoại","placeholder-class":"ph-style"},null,512),[[e.vModelText,l.phone]])]),e.createElementVNode("view",{class:"f-item"},[e.createElementVNode("picker",{mode:"selector",range:r.value,value:l.managerIndex,onChange:i},[e.createElementVNode("view",{class:"f-picker-box"},[e.createElementVNode("text",{class:e.normalizeClass(0===l.managerIndex?"text-ph":"text-val")},e.toDisplayString(r.value[l.managerIndex]),3),e.createElementVNode("text",{class:"arrow"},"▼")])],40,["range","value"])]),e.createElementVNode("view",{class:"f-item"},[e.createVNode(u,{startDate:l.startDate,endDate:l.endDate,"onUpdate:startDate":a[2]||(a[2]=e=>l.startDate=e),"onUpdate:endDate":a[3]||(a[3]=e=>l.endDate=e)},null,8,["startDate","endDate"])]),e.createElementVNode("view",{class:"f-actions"},[e.createElementVNode("button",{class:"btn-reset",onClick:c},"Đặt lại"),e.createElementVNode("button",{class:"btn-submit",onClick:d},"Lọc")])]),t.loading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-state"},"Đang tải dữ liệu...")):(e.openBlock(),e.createElementBlock("scroll-view",{key:1,"scroll-y":"",class:"customer-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.customers,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:"customer-item",onClick:e=>(e=>{o("select",e),m()})(t)},[e.createVNode(s,{name:t.name,size:40,class:"mr-3"},null,8,["name"]),e.createElementVNode("view",{class:"info-column"},[e.createElementVNode("text",{class:"name-text"},e.toDisplayString(t.name||"(Không tên)"),1),e.createElementVNode("text",{class:"phone-text"},e.toDisplayString(t.phone||"Không có SĐT"),1)]),e.createElementVNode("view",{class:"date-column"},[e.createElementVNode("text",{class:"date-text"},e.toDisplayString(p(t.createAt)),1)])],8,["onClick"])))),128)),0===t.customers.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-state"},"Không có dữ liệu")):e.createCommentVNode("",!0)]))])])):e.createCommentVNode("",!0)}}),[["__scopeId","data-v-bfc41be5"]]);
/*!
   * pinia v2.1.7
   * (c) 2023 Eduardo San Martin Morote
   * @license MIT
   */
let p;const g=e=>p=e,f=Symbol();function v(e){return e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)&&"function"!=typeof e.toJSON}var h,y;(y=h||(h={})).direct="direct",y.patchObject="patch object",y.patchFunction="patch function";const k="undefined"!=typeof window;function C(){const t=e.effectScope(!0),a=t.run((()=>e.ref({})));let n=[],o=[];const l=e.markRaw({install(e){g(l),l._a=e,e.provide(f,l),e.config.globalProperties.$pinia=l,o.forEach((e=>n.push(e))),o=[]},use(e){return this._a?n.push(e):o.push(e),this},_p:n,_a:null,_e:t,_s:new Map,state:a});return l}const E=()=>{};function w(t,a,n,o=E){t.push(a);const l=()=>{const e=t.indexOf(a);e>-1&&(t.splice(e,1),o())};return!n&&e.getCurrentScope()&&e.onScopeDispose(l),l}function N(e,...t){e.slice().forEach((e=>{e(...t)}))}const V=e=>e();function b(t,a){t instanceof Map&&a instanceof Map&&a.forEach(((e,a)=>t.set(a,e))),t instanceof Set&&a instanceof Set&&a.forEach(t.add,t);for(const n in a){if(!a.hasOwnProperty(n))continue;const o=a[n],l=t[n];v(l)&&v(o)&&t.hasOwnProperty(n)&&!e.isRef(o)&&!e.isReactive(o)?t[n]=b(l,o):t[n]=o}return t}const T=Symbol();const{assign:x}=Object;function D(t,a,n={},o,l,r){let i;const s=x({actions:{}},n),c={deep:!0};let d,u,m,p=[],f=[];const y=o.state.value[t];let k;function C(a){let n;d=u=!1,"function"==typeof a?(a(o.state.value[t]),n={type:h.patchFunction,storeId:t,events:m}):(b(o.state.value[t],a),n={type:h.patchObject,payload:a,storeId:t,events:m});const l=k=Symbol();e.nextTick().then((()=>{k===l&&(d=!0)})),u=!0,N(p,n,o.state.value[t])}r||y||(o.state.value[t]={}),e.ref({});const D=r?function(){const{state:e}=n,t=e?e():{};this.$patch((e=>{x(e,t)}))}:E;function S(e,a){return function(){g(o);const n=Array.from(arguments),l=[],r=[];function i(e){l.push(e)}function s(e){r.push(e)}let c;N(f,{args:n,name:e,store:I,after:i,onError:s});try{c=a.apply(this&&this.$id===t?this:I,n)}catch(d){throw N(r,d),d}return c instanceof Promise?c.then((e=>(N(l,e),e))).catch((e=>(N(r,e),Promise.reject(e)))):(N(l,c),c)}}const _={_p:o,$id:t,$onAction:w.bind(null,f),$patch:C,$reset:D,$subscribe(a,n={}){const l=w(p,a,n.detached,(()=>r())),r=i.run((()=>e.watch((()=>o.state.value[t]),(e=>{("sync"===n.flush?u:d)&&a({storeId:t,type:h.direct,events:m},e)}),x({},c,n))));return l},$dispose:function(){i.stop(),p=[],f=[],o._s.delete(t)}},I=e.reactive(_);o._s.set(t,I);const B=(o._a&&o._a.runWithContext||V)((()=>o._e.run((()=>(i=e.effectScope()).run(a)))));for(const g in B){const a=B[g];if(e.isRef(a)&&(O=a,!e.isRef(O)||!O.effect)||e.isReactive(a))r||(!y||v(A=a)&&A.hasOwnProperty(T)||(e.isRef(a)?a.value=y[g]:b(a,y[g])),o.state.value[t][g]=a);else if("function"==typeof a){const e=S(g,a);B[g]=e,s.actions[g]=a}}var A,O;return x(I,B),x(e.toRaw(I),B),Object.defineProperty(I,"$state",{get:()=>o.state.value[t],set:e=>{C((t=>{x(t,e)}))}}),o._p.forEach((e=>{x(I,i.run((()=>e({store:I,app:o._a,pinia:o,options:s}))))})),y&&r&&n.hydrate&&n.hydrate(I.$state,y),d=!0,u=!0,I}function S(t,a,n){let o,l;const r="function"==typeof a;function i(t,n){const i=e.hasInjectionContext();(t=t||(i?e.inject(f,null):null))&&g(t),(t=p)._s.has(o)||(r?D(o,a,l,t):function(t,a,n,o){const{state:l,actions:r,getters:i}=a,s=n.state.value[t];let c;c=D(t,(function(){s||(n.state.value[t]=l?l():{});const a=e.toRefs(n.state.value[t]);return x(a,r,Object.keys(i||{}).reduce(((a,o)=>(a[o]=e.markRaw(e.computed((()=>{g(n);const e=n._s.get(t);return i[o].call(e,e)}))),a)),{}))}),a,n,0,!0)}(o,l,t));return t._s.get(o)}return"string"==typeof t?(o=t,l=r?n:a):(l=t,o=t.id),i.$id=o,i}let _="Store";function I(e,t){return Array.isArray(t)?t.reduce(((t,a)=>(t[a]=function(){return e(this.$pinia)[a]},t)),{}):Object.keys(t).reduce(((a,n)=>(a[n]=function(){const a=e(this.$pinia),o=t[n];return"function"==typeof o?o.call(this,a):a[o]},a)),{})}const B=I;const A=Object.freeze(Object.defineProperty({__proto__:null,get MutationType(){return h},PiniaVuePlugin:function(e){e.mixin({beforeCreate(){const e=this.$options;if(e.pinia){const t=e.pinia;if(!this._provided){const e={};Object.defineProperty(this,"_provided",{get:()=>e,set:t=>Object.assign(e,t)})}this._provided[f]=t,this.$pinia||(this.$pinia=t),t._a=this,k&&g(t)}else!this.$pinia&&e.parent&&e.parent.$pinia&&(this.$pinia=e.parent.$pinia)},destroyed(){delete this._pStores}})},acceptHMRUpdate:function(e,t){return()=>{}},createPinia:C,defineStore:S,getActivePinia:()=>e.hasInjectionContext()&&e.inject(f)||p,mapActions:function(e,t){return Array.isArray(t)?t.reduce(((t,a)=>(t[a]=function(...t){return e(this.$pinia)[a](...t)},t)),{}):Object.keys(t).reduce(((a,n)=>(a[n]=function(...a){return e(this.$pinia)[t[n]](...a)},a)),{})},mapGetters:B,mapState:I,mapStores:function(...e){return e.reduce(((e,t)=>(e[t.$id+_]=function(){return t(this.$pinia)},e)),{})},mapWritableState:function(e,t){return Array.isArray(t)?t.reduce(((t,a)=>(t[a]={get(){return e(this.$pinia)[a]},set(t){return e(this.$pinia)[a]=t}},t)),{}):Object.keys(t).reduce(((a,n)=>(a[n]={get(){return e(this.$pinia)[t[n]]},set(a){return e(this.$pinia)[t[n]]=a}},a)),{})},setActivePinia:g,setMapStoreSuffix:function(e){_=e},skipHydrate:function(e){return Object.defineProperty(e,T,{})},storeToRefs:function(t){{t=e.toRaw(t);const a={};for(const n in t){const o=t[n];(e.isRef(o)||e.isReactive(o))&&(a[n]=e.toRef(t,n))}return a}}},Symbol.toStringTag,{value:"Module"})),O="CALL",$="CUSTOMER",L="CONVERSATION",M="CHAT_MESSAGE",F="Desktop-RTC",R="TODO",U="",P="",z="",j="",H="",G="",q="072836272322",K="https://api-sandbox-h01.vbot.vn/v1.0",Y=`${K}/api/module-crm`,W=`${K}/api/project`,X=`${K}/api/module-todo/todo`,J="PR202511211001129372",Q=(e,t)=>{const a=te();return ae({url:`${Y}/token`,method:"GET",data:{projectCode:e,uid:t,type:"CRM",source:F},header:{Authorization:`Bearer ${a.rootToken}`}}).then((e=>e.token))},Z=e=>ae({url:`${Y}/Customer/getAllFieldSearch`,method:"POST",data:{},header:{Authorization:`Bearer ${e}`}}),ee=(e,t)=>ae({url:`${Y}/Customer/getAll`,method:"POST",data:t,header:{Authorization:`Bearer ${e}`}}),te=S("auth",{state:()=>({rootToken:uni.getStorageSync("vbot_root_token")||"",rootLoginTime:uni.getStorageSync("vbot_root_login_time")||0,todoToken:uni.getStorageSync("todo_access_token")||"",crmToken:uni.getStorageSync("crm_access_token")||"",uid:uni.getStorageSync("vbot_uid")||"",projectCode:uni.getStorageSync("vbot_project_code")||""}),getters:{isLoggedIn:e=>!!e.todoToken&&!!e.crmToken,isRootTokenValid:e=>{if(!e.rootToken||!e.rootLoginTime)return!1;return Date.now()-e.rootLoginTime<6048e5}},actions:{setAuthData(e){e.rootToken&&(this.rootToken=e.rootToken,uni.setStorageSync("vbot_root_token",e.rootToken),this.rootLoginTime=Date.now(),uni.setStorageSync("vbot_root_login_time",this.rootLoginTime)),e.uid&&(this.uid=e.uid,uni.setStorageSync("vbot_uid",e.uid)),e.projectCode&&(this.projectCode=e.projectCode,uni.setStorageSync("vbot_project_code",e.projectCode)),e.todoToken&&(this.todoToken=e.todoToken,uni.setStorageSync("todo_access_token",e.todoToken)),e.crmToken&&(this.crmToken=e.crmToken,uni.setStorageSync("crm_access_token",e.crmToken))},async fetchModuleTokens(){try{if(!this.isRootTokenValid)return t("log","at stores/auth.ts:61","Root Token hết hạn, login lại..."),void(await this.loginDevMode());t("log","at stores/auth.ts:66","Store: Đang lấy Token cho Todo và CRM...");const[o,l]=await Promise.all([(e=this.rootToken,a=this.projectCode,n=this.uid,new Promise(((t,o)=>{uni.request({url:`${Y}/token`,method:"GET",data:{projectCode:a,uid:n,type:R,source:F},header:{Authorization:`Bearer ${e}`},success:e=>{const a=e.data;a&&a.data&&a.data.token?t(a.data.token):o(a)},fail:e=>o(e)})}))),Q(this.projectCode,this.uid)]);this.setAuthData({todoToken:o,crmToken:l}),t("log","at stores/auth.ts:78"," Store: Đã lấy đủ Token (Todo & CRM).")}catch(o){throw t("error","at stores/auth.ts:80"," Store: Lỗi lấy module tokens:",o),this.logout(),o}var e,a,n},async loginDevMode(){try{t("log","at stores/auth.ts:97","Store: Đang gọi API đăng nhập hệ thống...");const n=await(e="hoangtinvpm",a="ef797c8118f02dfb649607dd5d3f8c7623048c9c063d532cc95c5ed7a898a64f",new Promise(((t,n)=>{uni.request({url:"https://api-sandbox-h01.vbot.vn/v1.0/token",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{username:e,password:a,grant_type:"password",type_account:0,source:F},success:e=>{const a=e.data;200===e.statusCode&&a.access_token?t(a):n(a)},fail:e=>n(e)})})));this.setAuthData({rootToken:n.access_token,uid:"87d90802634146e29721476337bce64b",projectCode:"PR202511211001129372"}),await this.fetchModuleTokens()}catch(n){t("error","at stores/auth.ts:108"," Store: Đăng nhập Dev thất bại",n)}var e,a},async initialize(e){if(t("log","at stores/auth.ts:113"," Store: Khởi tạo Auth..."),this.todoToken&&this.crmToken)t("log","at stores/auth.ts:115",">>  Đã có đủ Token cũ. Ready!");else{if(this.isRootTokenValid)return t("log","at stores/auth.ts:120","️ Thiếu token module, đang lấy lại..."),void(await this.fetchModuleTokens());t("log","at stores/auth.ts:125","Root Token hết hạn. Login lại..."),await this.loginDevMode()}},async exchangeForTodoToken(){await this.fetchModuleTokens()},logout(){t("log","at stores/auth.ts:132","Store: Đăng xuất..."),this.rootToken="",this.rootLoginTime=0,this.todoToken="",this.crmToken="",uni.removeStorageSync("crm_access_token"),uni.removeStorageSync("todo_access_token"),uni.removeStorageSync("vbot_root_token"),uni.removeStorageSync("vbot_root_login_time")}}}),ae=async e=>{const a=te(),n=a.todoToken||a.rootToken,o={"Content-Type":"application/json",...e.header};return n&&(o.Authorization=`Bearer ${n}`),new Promise(((n,l)=>{uni.request({url:e.url,method:e.method||"GET",data:e.data||{},header:o,success:async o=>{const r=o.data;if(200!==o.statusCode)if(401!==o.statusCode)t("error","at utils/request.ts:66",`[API Error ${o.statusCode}]`,r),l(r);else{if(t("warn","at utils/request.ts:40",`API 401: Token hết hạn tại ${e.url}`),e._isRetry)return t("error","at utils/request.ts:43"," Refresh Token cũng thất bại -> Logout."),a.logout(),void l(r);try{await a.exchangeForTodoToken(),t("log","at utils/request.ts:51"," Đã Refresh Token -> Đang gọi lại API cũ...");const o=await ae({...e,_isRetry:!0});n(o)}catch(i){a.logout(),l(i)}}else n(r.data)},fail:e=>{t("error","at utils/request.ts:71","[Network Error]",e),l(e)}})}))},ne="TO_DO",oe="IN_PROGRESS",le="DONE",re={TO_DO:"Chờ xử lý",IN_PROGRESS:"Đang xử lý",DONE:"Hoàn thành"},ie={TO_DO:"bg-gray",IN_PROGRESS:"bg-orange",DONE:"bg-green"},se={HISTORY_CALL_IN:"Cuộc gọi đến",HISTORY_CALL_OUT:"Cuộc gọi đi",HISTORY_MISS_CALL:"Cuộc gọi nhỡ",NEW_TICKET:"Tạo mới ticket",REOPEN_TICKET:"Mở lại ticket",NEW_SUB_TICKET:"Tạo ticket con",UPDATE_STATUS_TICKET:"Cập nhật trạng thái ticket",UPDATE_ASSIGNEE_TICKET:"Đổi người xử lý ticket",NEW_TODO:"Tạo mới công việc",REOPEN_TODO:"Mở lại công việc",UPDATE_STATUS_TODO:"Cập nhật trạng thái công việc",UPDATE_ASSIGNEE_TODO:"Đổi người thực hiện công việc",CUSTOMER_UPDATE:"Cập nhật thông tin khách hàng",NOTE_INSERT:"Thêm ghi chú",NOTE_UPDATE:"Sửa ghi chú",NOTE_DELETE:"Xóa ghi chú"},ce=e=>{if(!e||-1===e||0===e)return"";const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`},de=e=>{if(!e)return-1;const t=e.replace(/-/g,"/");return new Date(`${t} 00:00:00`).getTime()},ue=e=>{if(!e)return-1;const t=e.replace(/-/g,"/");return new Date(`${t} 00:00:00`).getTime()},me=async e=>{const t=await ae({url:`${X}/getAll`,method:"GET",data:{projectCode:J,pageNo:1,pageSize:15,...e}});return Array.isArray(t)?t.map((e=>(e=>{if(!e)return{};const t=e.status||ne,a=e.title||"Không tên";return{...e,title:a,statusClass:ie[t]||"bg-orange",statusLabel:re[t]||t,avatarText:a.substring(0,2).toUpperCase(),createdAtFormatted:ce(e.createdAt)}})(e))):[]},pe=async e=>{const t=await ae({url:`${X}/countAll`,method:"GET",data:{projectCode:J,...e}});return Number(t)||0},ge=e=>ae({url:`${X}/update`,method:"POST",data:e}),fe=e=>ae({url:`${K}/api/module-todo/todoMessages/create`,method:"POST",data:e}),ve=e=>{const t=te();return new Promise(((a,n)=>{uni.uploadFile({url:`${K}/api/module-todo/file/upload`,filePath:e,name:"file",header:{Authorization:`Bearer ${t.todoToken}`},success:e=>{try{const t=JSON.parse(e.data);200===t.status&&t.data?a(t.data):n(t.message||"Upload thất bại")}catch(t){n("Lỗi phân tích phản hồi từ server")}},fail:e=>{n(e)}})}))},he=()=>{const e=te(),{rootToken:t,projectCode:a}=e;return new Promise(((e,n)=>{uni.request({url:`${W}/getAllMember`,method:"GET",data:{projectCode:a,status:"all"},header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},success:t=>{const a=t.data;1===a.status&&a.data?e(a.data):n(a.message||"Lỗi lấy danh sách thành viên")},fail:e=>{n(e)}})}))},ye=(e,t="success")=>{uni.$emit("app-toast-show",{message:e,type:t})},ke=e=>ye(e,"success"),Ce=e=>ye(e,"error"),Ee=e=>ye(e,"info"),we=(e="Đang xử lý...")=>uni.showLoading({title:e,mask:!0}),Ne=()=>uni.hideLoading(),Ve=()=>{const a=e.ref([]),o=e.ref(!1),l=e.ref(!1),r=te(),i=e.ref(!1),s=e.ref(!1),c=e.ref([]),d=e.ref(""),u=e.ref(!1),m=e.ref(null),p=["Tất cả",re[ne],re[oe],re[le]],g=["",ne,oe,le],f=e.ref(0),v=e.ref([]),h=e.ref(["Tất cả"]),y=e.ref(0),k=e.ref(0),C=e.ref(["Tất cả"]),E=e.ref(0),w=["",O,$,L,M],N=e.ref(0),V=e.ref({title:"",jobCode:"",createdFrom:"",createdTo:"",dueDateFrom:"",dueDateTo:"",customerCode:"",notifyFrom:"",notifyTo:""}),b=[5,10,15,20],T=e.ref(2),x=e.ref(1),D=e.ref(0),S=e.computed((()=>{if(0===D.value)return 1;const e=b[T.value];return Math.ceil(D.value/e)})),_=async()=>{o.value=!0;try{let e="";if(y.value>0){e=v.value[y.value-1].UID||""}let t="";if(E.value>0){t=v.value[E.value-1].UID||""}const n=((e,t,a,n,o)=>({keySearch:e.title||"",code:e.jobCode||"",status:t||"",startDate:de(e.createdFrom),endDate:ue(e.createdTo),dueDateFrom:de(e.dueDateFrom),dueDateTo:ue(e.dueDateTo),notificationReceivedAtFrom:de(e.notifyFrom),notificationReceivedAtTo:ue(e.notifyTo),createdBy:n||"",assigneeId:o||"",customerCode:e.customerCode||"",links:a||"",groupId:"",transId:"",pluginType:""}))(V.value,g[f.value],w[N.value],e,t),l=b[T.value],[r,i]=await Promise.all([me({...n,pageNo:x.value,pageSize:l}),pe(n)]);a.value=r||[],D.value=i||0}catch(e){t("error","at controllers/list_todo.ts:111",e),Ce("Lỗi tải dữ liệu")}finally{o.value=!1}},I=async(e=null)=>{s.value=!0;try{const a=r.crmToken;if(!a)return void t("error","at controllers/list_todo.ts:122","Chưa có CRM Token!");const n=await Z(a),o=n.find((e=>"name"===e.code)),l=n.find((e=>"phone"===e.code)),i=n.find((e=>"member_no"===e.code)),d=o?o.id:134,u=l?l.id:135,m=i?i.id:136,p={page:1,size:20,fieldSearch:[{id:-1,value:"",type:"",isSearch:!1},{id:d,value:(null==e?void 0:e.name)||"",type:"",isSearch:!!(null==e?void 0:e.name)},{id:u,value:(null==e?void 0:e.phone)||"",type:"",isSearch:!!(null==e?void 0:e.phone)},{id:m,value:"",type:"",isSearch:!1}]},g=await ee(a,p);c.value=g.map((e=>{const t=e.customerFieldItems.find((e=>"name"===e.code)),a=e.customerFieldItems.find((e=>"phone"===e.code));return{id:e.id,uid:e.uid,createAt:e.createAt,name:t?t.value:"(Không tên)",phone:a?a.value:"",code:e.code||""}}))}catch(a){t("error","at controllers/list_todo.ts:162","Lỗi tải khách hàng:",a),Ce("Lỗi tải dữ liệu CRM")}finally{s.value=!1}},B=()=>{l.value=!1};n((()=>{_()}));return{todos:a,isLoading:o,isFilterOpen:l,filter:V,goToDetail:e=>{uni.navigateTo({url:`/pages/todo/todo_detail?id=${e.id}`})},isConfirmDeleteOpen:u,itemToDelete:m,pageSizeOptions:["5/trang","10/trang","15/trang","20/trang"],pageSizeIndex:T,currentPage:x,totalPages:S,totalItems:D,onPageSizeChange:e=>{T.value=e.detail.value,x.value=1,_()},changePage:e=>{const t=x.value+e;t>=1&&t<=S.value&&(x.value=t,_())},statusOptions:p,statusIndex:f,onStatusChange:e=>{f.value=e.detail.value},creatorOptions:h,creatorIndex:y,onCreatorChange:e=>{y.value=e.detail.value},assigneeOptions:C,assigneeIndex:E,onAssigneeChange:e=>{E.value=e.detail.value},sourceOptions:["Tất cả","Cuộc gọi","Khách hàng","Hội thoại","Tin nhắn"],sourceIndex:N,onSourceChange:e=>{N.value=e.detail.value},addNewTask:()=>{uni.navigateTo({url:"/pages/todo/create_todo"})},openFilter:()=>{l.value=!0,(async()=>{if(!(v.value.length>0))try{const e=await he();v.value=e;const t=e.map((e=>e.UserName||"Thành viên ẩn"));h.value=["Tất cả",...t],C.value=["Tất cả",...t]}catch(e){t("error","at controllers/list_todo.ts:71","Lỗi lấy danh sách thành viên filter:",e)}})()},closeFilter:B,resetFilter:()=>{V.value={title:"",jobCode:"",createdFrom:"",createdTo:"",dueDateFrom:"",dueDateTo:"",customerCode:"",notifyFrom:"",notifyTo:""},f.value=0,y.value=0,k.value=0,E.value=0,N.value=0,x.value=1,d.value=""},applyFilter:()=>{x.value=1,B(),_()},showActionMenu:e=>{uni.showActionSheet({itemList:["Xóa"],itemColor:"#ff3b30",success:t=>{0===t.tapIndex&&(e=>{m.value=e,u.value=!0})(e)}})},cancelDelete:()=>{u.value=!1,m.value=null},confirmDelete:async()=>{var e;if(m.value)try{await(e=m.value.id,ae({url:`${X}/delete`,method:"POST",data:{id:e}})),ke("Đã xóa thành công"),u.value=!1,m.value=null,_()}catch(a){t("error","at controllers/list_todo.ts:209","Delete Error:",a),Ce("Xóa thất bại")}},showCustomerModal:i,loadingCustomer:s,customerList:c,selectedCustomerName:d,openCustomerPopup:()=>{i.value=!0,0===c.value.length&&I()},onCustomerSelect:e=>{V.value.customerCode=e.uid,d.value=e.name,i.value=!1},onFilterCustomerInModal:e=>{I(e)}}},be=i(e.defineComponent({__name:"StatusBadge",props:{status:{}},setup(t){const a=t,n=e.computed((()=>re[a.status]||a.status||"Không xác định")),o=e.computed((()=>{switch(a.status){case ne:return"bg-gray-200 text-gray-600";case oe:return"bg-orange-100 text-orange-600";case le:return"bg-green-100 text-green-600";default:return"bg-gray-100 text-gray-400"}})),l=e.computed((()=>{switch(a.status){case ne:return{backgroundColor:"#e4e4e7",color:"#52525b"};case oe:return{backgroundColor:"#ffedd5",color:"#c2410c"};case le:return{backgroundColor:"#dcfce7",color:"#15803d"};default:return{backgroundColor:"#f4f4f5",color:"#a1a1aa"}}}));return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["px-2 py-1 rounded-full text-xs font-bold inline-block text-center min-w-[80px]",o.value]),style:e.normalizeStyle(l.value)},e.toDisplayString(n.value),7))}}),[["__scopeId","data-v-d7087f32"]]),Te=i(e.defineComponent({__name:"AppButton",props:{label:{default:""},type:{default:"primary"},size:{default:"normal"},disabled:{type:Boolean,default:!1},loading:{type:Boolean,default:!1}},emits:["click"],setup(t,{emit:a}){const n=t,o=a,l=e=>{n.disabled||n.loading||o("click",e)};return(t,a)=>(e.openBlock(),e.createElementBlock("button",{class:e.normalizeClass(["app-btn",[`btn-${t.type}`,"small"===t.size?"btn-sm":"",{"is-disabled":t.disabled||t.loading}]]),disabled:t.disabled||t.loading,onClick:l,"hover-class":"btn-hover"},[t.loading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-spinner"})):e.createCommentVNode("",!0),e.renderSlot(t.$slots,"default",{},(()=>[e.createElementVNode("text",{class:"btn-text"},e.toDisplayString(t.label),1)]),!0)],10,["disabled"]))}}),[["__scopeId","data-v-6cb06cb3"]]),xe=i(e.defineComponent({__name:"GlobalMessage",setup(t){const a=e.ref(!1),n=e.ref(""),o=e.ref("success"),l=e.ref(0);let r=null;const i={success:"data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%23047857%22%3E%3Cpath%20d%3D%22M12%202C6.48%202%202%206.48%202%2012s4.48%2010%2010%2010%2010-4.48%2010-10S17.52%202%2012%202zm-2%2015l-5-5%201.41-1.41L10%2014.17l7.59-7.59L19%208l-9%209z%22%2F%3E%3C%2Fsvg%3E",error:"data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%23b91c1c%22%3E%3Cpath%20d%3D%22M12%202C6.47%202%202%206.47%202%2012s4.47%2010%2010%2010%2010-4.47%2010-10S17.53%202%2012%202zm5%2013.59L15.59%2017%2012%2013.41%208.41%2017%207%2015.59%2010.59%2012%207%208.41%208.41%207%2012%2010.59%2015.59%207%2017%208.41%2013.41%2012%2017%2015.59z%22%2F%3E%3C%2Fsvg%3E",info:"data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%231d4ed8%22%3E%3Cpath%20d%3D%22M12%202C6.48%202%202%206.48%202%2012s4.48%2010%2010%2010%2010-4.48%2010-10S17.52%202%2012%202zm1%2015h-2v-6h2v6zm0-8h-2V7h2v2z%22%2F%3E%3C%2Fsvg%3E",warning:"data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%23b45309%22%3E%3Cpath%20d%3D%22M1%2021h22L12%202%201%2021zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z%22%2F%3E%3C%2Fsvg%3E"},s=e.computed((()=>i[o.value]||i.info)),c=e=>{r&&(clearTimeout(r),a.value=!1),n.value=e.message,o.value=e.type||"success",setTimeout((()=>{a.value=!0}),50),r=setTimeout((()=>{a.value=!1}),2500)};return e.onMounted((()=>{const e=uni.getSystemInfoSync();l.value=e.statusBarHeight||0,uni.$on("app-toast-show",c)})),e.onUnmounted((()=>{uni.$off("app-toast-show",c)})),(t,r)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["global-message-container",{show:a.value}]),style:e.normalizeStyle({paddingTop:l.value+10+"px"})},[e.createElementVNode("view",{class:e.normalizeClass(["message-content",o.value])},[e.createElementVNode("image",{src:s.value,class:"msg-icon",mode:"aspectFit"},null,8,["src"]),e.createElementVNode("text",{class:"msg-text"},e.toDisplayString(n.value),1)],2)],6))}}),[["__scopeId","data-v-42ac5ceb"]]),De=i(e.defineComponent({__name:"ConfirmModal",props:{visible:{type:Boolean},title:{default:"Thông báo"},message:{default:""},cancelLabel:{default:"Hủy"},confirmLabel:{default:"Xác nhận"},confirmType:{default:"primary"}},emits:["update:visible","confirm","cancel"],setup(t,{emit:a}){const n=a,o=()=>{n("update:visible",!1),n("cancel")},l=()=>{n("confirm")};return(t,a)=>t.visible?(e.openBlock(),e.createElementBlock("view",{key:0,class:"modal-overlay",onClick:o},[e.createElementVNode("view",{class:"modal-container",onClick:a[0]||(a[0]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("view",{class:"modal-header"},[e.createElementVNode("text",{class:"modal-title"},e.toDisplayString(t.title),1)]),e.createElementVNode("view",{class:"modal-body"},[e.renderSlot(t.$slots,"default",{},(()=>[e.createElementVNode("text",null,e.toDisplayString(t.message),1)]),!0)]),e.createElementVNode("view",{class:"modal-footer"},[e.createVNode(Te,{type:"secondary",label:t.cancelLabel,class:"flex-1",onClick:o},null,8,["label"]),e.createVNode(Te,{type:t.confirmType,label:t.confirmLabel,class:"flex-1",onClick:l},null,8,["type","label"])])])])):e.createCommentVNode("",!0)}}),[["__scopeId","data-v-99c10f24"]]),Se=i(e.defineComponent({__name:"list_todo",setup(t){const{todos:a,isLoading:n,isFilterOpen:o,filter:l,isConfirmDeleteOpen:r,itemToDelete:i,pageSizeOptions:s,pageSizeIndex:c,currentPage:d,totalPages:p,onPageSizeChange:g,changePage:f,statusOptions:v,statusIndex:h,onStatusChange:y,creatorOptions:k,creatorIndex:C,onCreatorChange:E,customerOptions:w,customerIndex:N,onCustomerChange:V,assigneeOptions:b,assigneeIndex:T,onAssigneeChange:x,sourceOptions:D,sourceIndex:S,onSourceChange:_,addNewTask:I,openFilter:B,closeFilter:A,resetFilter:O,applyFilter:$,showActionMenu:L,cancelDelete:M,confirmDelete:F,goToDetail:R,showCustomerModal:U,loadingCustomer:P,customerList:z,selectedCustomerName:j,openCustomerPopup:H,onCustomerSelect:G,onFilterCustomerInModal:q}=Ve();return(t,w)=>{var N;return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"header-left"}),e.createElementVNode("text",{class:"header-title"},"Công việc"),e.createElementVNode("view",{class:"header-right",onClick:w[0]||(w[0]=(...t)=>e.unref(B)&&e.unref(B)(...t))},[e.createElementVNode("image",{src:"https://img.icons8.com/ios-filled/50/333333/filter--v1.png",class:"filter-icon"})])]),e.createElementVNode("view",{class:"content"},[e.createElementVNode("view",{class:"list-container"},[e.unref(n)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-state"},[e.createElementVNode("text",null,"Đang tải dữ liệu...")])):0===e.unref(a).length?(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-state"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/100/cccccc/empty-box.png",mode:"aspectFit",class:"empty-icon"}),e.createElementVNode("text",{class:"empty-text"},"Chưa có dữ liệu")])):(e.openBlock(),e.createElementBlock("scroll-view",{key:2,"scroll-y":"true",class:"list-view"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(a),((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:"card-item",onClick:a=>e.unref(R)(t)},[e.createElementVNode("view",{class:e.normalizeClass(["status-bar",t.statusClass])},null,2),e.createElementVNode("view",{class:"card-body"},[e.createElementVNode("view",{class:"card-row top-row"},[e.createElementVNode("text",{class:"card-title"},e.toDisplayString(t.title),1),e.createElementVNode("view",{class:"action-btn",onClick:e.withModifiers((a=>e.unref(L)(t)),["stop"])},[e.createElementVNode("text",{class:"dots"},"•••")],8,["onClick"])]),e.createElementVNode("view",{class:"card-row mid-row"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/time.png",class:"icon-small"}),e.createElementVNode("text",{class:"card-date"},"Ngày tạo: "+e.toDisplayString(t.createdAtFormatted),1)]),e.createElementVNode("view",{class:"card-row bot-row"},[e.createElementVNode("view",{class:"code-tag"},"#"+e.toDisplayString(t.code),1),e.createVNode(be,{status:t.status},null,8,["status"])])])],8,["onClick"])))),128)),e.createElementVNode("view",{style:{height:"20px"}})]))]),e.createElementVNode("view",{class:"fixed-footer"},[e.createElementVNode("picker",{mode:"selector",range:e.unref(s),value:e.unref(c),onChange:w[1]||(w[1]=(...t)=>e.unref(g)&&e.unref(g)(...t))},[e.createElementVNode("view",{class:"page-size-selector"},[e.createElementVNode("text",{class:"size-text"},e.toDisplayString(e.unref(s)[e.unref(c)]),1),e.createElementVNode("text",{class:"dropdown-arrow"},"▼")])],40,["range","value"]),e.createElementVNode("view",{class:"pagination-controls"},[e.createElementVNode("view",{class:e.normalizeClass(["page-arrow",{disabled:e.unref(d)<=1}]),onClick:w[2]||(w[2]=t=>e.unref(f)(-1))},"‹",2),e.createElementVNode("view",{class:"page-box active"},e.toDisplayString(e.unref(d)),1),e.createElementVNode("view",{class:e.normalizeClass(["page-arrow",{disabled:e.unref(d)>=e.unref(p)}]),onClick:w[3]||(w[3]=t=>e.unref(f)(1))},"› ",2)]),e.createElementVNode("view",{class:"add-task-simple",onClick:w[4]||(w[4]=(...t)=>e.unref(I)&&e.unref(I)(...t))},[e.createElementVNode("text",{class:"plus-icon"},"+"),e.createElementVNode("text",{class:"add-text"},"Thêm công việc")])])]),e.unref(o)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"filter-overlay",onClick:w[20]||(w[20]=e.withModifiers(((...t)=>e.unref(A)&&e.unref(A)(...t)),["stop"]))},[e.createElementVNode("view",{class:"filter-panel",onClick:w[19]||(w[19]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("view",{class:"filter-header"},[e.createElementVNode("text",{class:"filter-title"},"Bộ lọc tìm kiếm"),e.createElementVNode("text",{class:"close-btn",onClick:w[5]||(w[5]=(...t)=>e.unref(A)&&e.unref(A)(...t))},"✕")]),e.createElementVNode("scroll-view",{"scroll-y":"true",class:"filter-body"},[e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Tiêu đề / Từ khóa"),e.withDirectives(e.createElementVNode("input",{class:"f-input","onUpdate:modelValue":w[6]||(w[6]=t=>e.unref(l).title=t),placeholder:"Nhập từ khóa..."},null,512),[[e.vModelText,e.unref(l).title]])]),e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Mã công việc"),e.withDirectives(e.createElementVNode("input",{class:"f-input","onUpdate:modelValue":w[7]||(w[7]=t=>e.unref(l).jobCode=t),placeholder:"Ví dụ: TODO-08"},null,512),[[e.vModelText,e.unref(l).jobCode]])]),e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Trạng thái"),e.createElementVNode("picker",{mode:"selector",range:e.unref(v),value:e.unref(h),onChange:w[8]||(w[8]=(...t)=>e.unref(y)&&e.unref(y)(...t))},[e.createElementVNode("view",{class:"f-picker"},[e.createTextVNode(e.toDisplayString(e.unref(v)[e.unref(h)]),1),e.createElementVNode("text",{class:"arrow"},"▼")])],40,["range","value"])]),e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Người tạo"),e.createElementVNode("picker",{mode:"selector",range:e.unref(k),value:e.unref(C),onChange:w[9]||(w[9]=(...t)=>e.unref(E)&&e.unref(E)(...t))},[e.createElementVNode("view",{class:"f-picker"},[e.createTextVNode(e.toDisplayString(e.unref(k)[e.unref(C)]),1),e.createElementVNode("text",{class:"arrow"},"▼")])],40,["range","value"])]),e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Khách hàng"),e.createElementVNode("view",{class:"f-input",onClick:w[10]||(w[10]=(...t)=>e.unref(H)&&e.unref(H)(...t)),style:{"justify-content":"space-between"}},[e.createElementVNode("text",{style:e.normalizeStyle({color:e.unref(j)?"#333":"#999"})},e.toDisplayString(e.unref(j)||"Chọn khách hàng"),5),e.createElementVNode("text",{class:"arrow"},"›")])]),e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Người được giao"),e.createElementVNode("picker",{mode:"selector",range:e.unref(b),value:e.unref(T),onChange:w[11]||(w[11]=(...t)=>e.unref(x)&&e.unref(x)(...t))},[e.createElementVNode("view",{class:"f-picker"},[e.createTextVNode(e.toDisplayString(e.unref(b)[e.unref(T)]),1),e.createElementVNode("text",{class:"arrow"},"▼")])],40,["range","value"])]),e.createElementVNode("view",{class:"f-group"},[e.createElementVNode("text",{class:"f-label"},"Nguồn"),e.createElementVNode("picker",{mode:"selector",range:e.unref(D),value:e.unref(S),onChange:w[12]||(w[12]=(...t)=>e.unref(_)&&e.unref(_)(...t))},[e.createElementVNode("view",{class:"f-picker"},[e.createTextVNode(e.toDisplayString(e.unref(D)[e.unref(S)]),1),e.createElementVNode("text",{class:"arrow"},"▼")])],40,["range","value"])]),e.createVNode(u,{title:"Thời gian tạo",startDate:e.unref(l).createdFrom,"onUpdate:startDate":w[13]||(w[13]=t=>e.unref(l).createdFrom=t),endDate:e.unref(l).createdTo,"onUpdate:endDate":w[14]||(w[14]=t=>e.unref(l).createdTo=t)},null,8,["startDate","endDate"]),e.createVNode(u,{title:"Thời gian hết hạn",startDate:e.unref(l).dueDateFrom,"onUpdate:startDate":w[15]||(w[15]=t=>e.unref(l).dueDateFrom=t),endDate:e.unref(l).dueDateTo,"onUpdate:endDate":w[16]||(w[16]=t=>e.unref(l).dueDateTo=t)},null,8,["startDate","endDate"]),e.createVNode(u,{title:"Thời gian thông báo",startDate:e.unref(l).notifyFrom,"onUpdate:startDate":w[17]||(w[17]=t=>e.unref(l).notifyFrom=t),endDate:e.unref(l).notifyTo,"onUpdate:endDate":w[18]||(w[18]=t=>e.unref(l).notifyTo=t)},null,8,["startDate","endDate"]),e.createElementVNode("view",{style:{height:"20px"}})]),e.createElementVNode("view",{class:"filter-footer"},[e.createVNode(Te,{type:"secondary",label:"Đặt lại",class:"btn-filter-reset",onClick:e.unref(O)},null,8,["onClick"]),e.createVNode(Te,{type:"primary",label:"Áp dụng",class:"btn-filter-apply",onClick:e.unref($)},null,8,["onClick"])])])])):e.createCommentVNode("",!0),e.createVNode(m,{visible:e.unref(U),loading:e.unref(P),customers:e.unref(z),onClose:w[21]||(w[21]=e=>U.value=!1),onSelect:e.unref(G),onFilter:e.unref(q)},null,8,["visible","loading","customers","onSelect","onFilter"]),e.createVNode(De,{visible:e.unref(r),"onUpdate:visible":w[22]||(w[22]=t=>e.isRef(r)?r.value=t:null),title:"Thông báo",message:`Bạn có chắc muốn xóa công việc "${null==(N=e.unref(i))?void 0:N.title}"?`,"confirm-type":"danger",onConfirm:e.unref(F),onCancel:e.unref(M)},null,8,["visible","message","onConfirm","onCancel"]),e.createVNode(xe)])}}}),[["__scopeId","data-v-23b207aa"]]),_e=e=>{if(!e)return-1;const t=e.replace(/\//g,"-"),a=new Date(t);return isNaN(a.getTime())?-1:a.getTime()},Ie=()=>{const a=te(),n=e=>e.toString().padStart(2,"0"),o=()=>{const e=new Date;return`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())}`},l=e.ref(!1),r=e.ref({name:"",desc:"",customer:"",customerUid:"",assignee:"",dueDate:o(),notifyDate:o(),notifyTime:(()=>{const e=new Date;return`${n(e.getHours())}:${n(e.getMinutes())}`})()}),i=[O,$,L],s=e.ref(-1),c=e.ref([]),d=e.ref([]),u=e.ref(-1),m=e.ref(!1),p=e.ref(!1),g=e.ref([]),f=e.ref(""),v=e.computed((()=>u.value>-1&&d.value.length>0?d.value[u.value]:""));return e.onMounted((()=>{(async()=>{try{const e=await he();c.value=e,d.value=e.map((e=>e.UserName||"Thành viên ẩn danh"))}catch(e){t("error","at controllers/create_todo.ts:57","Lỗi lấy thành viên:",e),Ce("Không thể tải danh sách thành viên")}})()})),{loading:l,form:r,memberOptions:d,onMemberChange:e=>{const t=e.detail.value;u.value=t;const a=c.value[t];a&&(r.value.assignee=a.memberUID)},currentAssigneeName:v,showCustomerModal:m,loadingCustomer:p,customerList:g,openCustomerPopup:()=>{m.value=!0,(async()=>{if(!(g.value.length>0)){p.value=!0;try{const e=a.crmToken;if(!e)return void t("error","at controllers/create_todo.ts:69","Chưa có CRM Token!");f.value=e;const n=await Z(e),o=n.find((e=>"name"===e.code)),l=n.find((e=>"phone"===e.code)),r=n.find((e=>"member_no"===e.code)),i=o?o.id:134,s={page:1,size:20,fieldSearch:[{id:-1,value:"",type:"",isSearch:!1},{id:i,value:"",type:"",isSearch:!1},{id:l?l.id:135,value:"",type:"",isSearch:!1},{id:r?r.id:136,value:"",type:"",isSearch:!1}]},c=await ee(e,s);g.value=c.map((e=>{const t=e.customerFieldItems.find((e=>"name"===e.code)),a=e.customerFieldItems.find((e=>"phone"===e.code));return{id:e.id,uid:e.uid,createAt:e.createAt,name:t?t.value:"(Không tên)",phone:a?a.value:""}}))}catch(e){t("error","at controllers/create_todo.ts:109","Lỗi tải khách hàng:",e),Ce("Lỗi tải dữ liệu CRM")}finally{p.value=!1}}})()},onCustomerSelect:e=>{r.value.customer=`${e.name} - ${e.phone}`,r.value.customerUid=e.uid},goBack:()=>uni.navigateBack(),submitForm:async()=>{if(!r.value.name||!r.value.name.trim())return void Ee("Vui lòng nhập tên công việc");let e="CALL";s.value>=0&&(e=i[s.value]),l.value=!0,we("Đang xử lý dữ liệu...");try{const{newContent:n,fileUrls:o}=await(async e=>{if(!e)return{newContent:"",fileUrls:[]};const a=/<img[^>]+src="([^">]+)"/g;let n;const o=[],l=[],r=[];for(;null!==(n=a.exec(e));){const e=n[1];if(!e.startsWith("http")||e.startsWith("file://")||e.startsWith("blob:")){const a=ve(e).then((t=>{l.push({oldSrc:e,newSrc:t}),r.push(t)})).catch((a=>{t("error","at controllers/create_todo.ts:161",`Upload ảnh ${e} lỗi:`,a)}));o.push(a)}}o.length>0&&await Promise.all(o);let i=e;return l.forEach((e=>{i=i.split(e.oldSrc).join(e.newSrc)})),{newContent:i,fileUrls:r}})(r.value.desc);r.value.desc=n;const i=((e,t)=>{const a=`${e.notifyDate} ${e.notifyTime||"00:00"}`,n=e.dueDate;return{title:e.name,description:e.desc||U,projectCode:t.projectCode,createdBy:t.uid,status:ne,links:t.link||O,pluginType:P,customerCode:e.customerUid||G,assigneeId:e.assignee||H,groupId:z,transId:j,tagCodes:"test1",groupMemberUid:"test1",files:t.uploadedFiles||U,phone:q,dueDate:_e(n),notificationReceivedAt:_e(a)}})(r.value,{projectCode:J,uid:"87d90802634146e29721476337bce64b",link:e,uploadedFiles:o.length>0?o[0]:""});t("log","at controllers/create_todo.ts:204","Payload Submit:",i),await(a=i,ae({url:`${X}/create`,method:"POST",data:a})),Ne(),ke("Tạo thành công!"),setTimeout((()=>{uni.navigateBack()}),1500)}catch(n){Ne(),t("error","at controllers/create_todo.ts:214","Create Error:",n);const e=(null==n?void 0:n.message)||("string"==typeof n?n:"Thất bại");Ce("Lỗi: "+e)}finally{l.value=!1}var a},sourceOptions:["Cuộc gọi","Khách hàng","Hội thoại"],sourceIndex:s,onSourceChange:e=>{s.value=parseInt(e.detail.value)}}},Be=i(e.defineComponent({__name:"TodoEditor",props:{modelValue:String,placeholder:{type:String,default:"Nhập nội dung..."}},emits:["update:modelValue"],setup(t,{emit:a}){const n=t,o=a,l=[{name:"header",iconText:"H",style:"font-weight:bold",action:"header-menu"},{name:"fontSize",iconText:"A",style:"font-weight:bold; font-size:16px",action:"fontsize-menu"},{name:"bold",iconText:"B",style:"font-weight:900"},{name:"italic",iconText:"I",style:"font-style:italic"},{name:"underline",iconText:"U",style:"text-decoration:underline"},{name:"color",iconImg:"https://img.icons8.com/ios-filled/50/000000/text-color.png",action:"color-picker"},{name:"backgroundColor",iconImg:"https://img.icons8.com/ios-filled/50/000000/marker-pen.png",action:"bgcolor-picker"},{name:"strike",iconText:"S",style:"text-decoration:line-through"},{name:"align",iconImg:"https://img.icons8.com/ios/50/666666/align-left.png",action:"align-menu"},{name:"list",value:"ordered",iconImg:"https://img.icons8.com/ios/50/666666/numbered-list.png"},{name:"list",value:"bullet",iconImg:"https://img.icons8.com/ios/50/666666/list.png"}],r=["#000000","#333333","#888888","#aaaaaa","#e60000","#ff9900","#ffff00","#008a00","#0066cc","#880088","#ffffff","#facccc","#ffebcc","#ffffcc","#cce8cc","#cce0f5"],i=e.ref(`editor-${Math.random().toString(36).substr(2,5)}`),s=e.ref(null),c=e.ref({}),d=e.getCurrentInstance(),u=e.ref(!1),m=e.ref(!1),p=e.ref(""),g=e.ref(!1),f=e.ref("color"),v=e=>{const t=c.value[e.name];return"header-menu"===e.action?t?`H${t}`:"H":"fontsize-menu"===e.action?"small"===t?"Sm":"large"===t?"Lg":"huge"===t?"Hg":"A":e.iconText},h=e=>{if("align-menu"===e.action){switch(c.value.align||"left"){case"center":return"https://img.icons8.com/ios/50/666666/align-center.png";case"right":return"https://img.icons8.com/ios/50/666666/align-right.png";case"justify":return"https://img.icons8.com/ios/50/666666/align-justify.png";default:return"https://img.icons8.com/ios/50/666666/align-left.png"}}return e.iconImg},y=e=>{x(f.value,e||null),g.value=!1},k=()=>{g.value=!1},C=()=>{uni.showActionSheet({itemList:["Căn trái","Căn giữa","Căn phải","Căn đều"],success:e=>{const t=e.tapIndex;0===t&&x("align","left"),1===t&&x("align","center"),2===t&&x("align","right"),3===t&&x("align","justify")}})},E=()=>{uni.showActionSheet({itemList:["Nhỏ","Bình thường","Lớn","Rất lớn"],success:e=>{const t=e.tapIndex;0===t&&x("fontSize","small"),1===t&&x("fontSize",null),2===t&&x("fontSize","large"),3===t&&x("fontSize","huge")}})},w=()=>{uni.showActionSheet({itemList:["Tiêu đề 1 (H1)","Tiêu đề 2 (H2)","Tiêu đề 3 (H3)","Tiêu đề 4 (H4)","Tiêu đề 5 (H5)","Tiêu đề 6 (H6)","Văn bản thường"],success:e=>{e.tapIndex<6?x("header",e.tapIndex+1):x("header",null)}})},N=e=>{const t=c.value[e.name];return"header-menu"===e.action||"fontsize-menu"===e.action?!!t:"align-menu"===e.action?!!t&&"left"!==t:"color"===e.name?!!c.value.color:"backgroundColor"===e.name?!!c.value.backgroundColor:e.value?t===e.value:!!t},V=()=>{uni.createSelectorQuery().in(d).select(`#${i.value}`).context((e=>{e&&e.context&&(s.value=e.context,n.modelValue&&s.value.setContents({html:n.modelValue}))})).exec()},b=e=>{const t=e.detail.html;B.value=t,o("update:modelValue",t)},T=e=>{c.value=e.detail,u.value=!!e.detail.link},x=(e,t=null)=>{s.value&&s.value.format(e,t)},D=()=>{uni.showActionSheet({itemList:["Chụp ảnh mới","Chọn từ thư viện"],success:e=>{const t=e.tapIndex;let a="album";0===t&&(a="camera"),1===t&&(a="album"),uni.chooseImage({count:1,sourceType:[a],success:e=>{s.value&&s.value.insertImage({src:e.tempFilePaths[0],width:"80%",alt:"image"})}})}})},S=()=>{u.value?s.value.format("link",null):(p.value="",m.value=!0)},_=()=>{p.value&&s.value.format("link",p.value),m.value=!1},I=()=>{s.value.removeFormat()},B=e.ref("");return e.watch((()=>n.modelValue),(e=>{e!==B.value&&s.value&&(e?s.value.setContents({html:e}):s.value.clear(),B.value=e||"")})),(a,n)=>(e.openBlock(),e.createElementBlock("view",{class:"editor-container"},[e.createElementVNode("editor",{id:i.value,class:"ql-container",placeholder:t.placeholder,"show-img-size":"","show-img-toolbar":"","show-img-resize":"",onReady:V,onInput:b,onStatuschange:T},null,40,["id","placeholder"]),e.createElementVNode("view",{class:"toolbar"},[e.createElementVNode("view",{class:"tool-list"},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(l,((t,a)=>e.createElementVNode("view",{key:a,class:e.normalizeClass(["tool-item",{active:N(t)}]),onTouchend:e.withModifiers((e=>(e=>"header-menu"===e.action?w():"fontsize-menu"===e.action?E():"align-menu"===e.action?C():"color-picker"===e.action?(f.value="color",void(g.value=!0)):"bgcolor-picker"===e.action?(f.value="backgroundColor",void(g.value=!0)):void x(e.name,e.value))(t)),["prevent"])},[t.iconText?(e.openBlock(),e.createElementBlock("text",{key:0,style:e.normalizeStyle(t.style),class:e.normalizeClass(["txt-icon",{"txt-dynamic":t.action}])},e.toDisplayString(v(t)),7)):(e.openBlock(),e.createElementBlock("image",{key:1,src:h(t),class:"img-icon"},null,8,["src"]))],42,["onTouchend"]))),64)),e.createElementVNode("view",{class:"tool-divider"}),e.createElementVNode("view",{class:"tool-item",onTouchend:e.withModifiers(D,["prevent"])},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/image.png",class:"img-icon"})],32),e.createElementVNode("view",{class:e.normalizeClass(["tool-item",{active:u.value}]),onTouchend:e.withModifiers(S,["prevent"])},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/link--v1.png",class:"img-icon"})],34),e.createElementVNode("view",{class:"tool-item",onTouchend:e.withModifiers(I,["prevent"])},[e.createElementVNode("text",{class:"txt-icon",style:{"font-size":"12px"}},"Clear")],32)])]),m.value?(e.openBlock(),e.createElementBlock("view",{key:0,class:"modal-overlay",onClick:n[3]||(n[3]=e=>m.value=!1)},[e.createElementVNode("view",{class:"modal-box",onClick:n[2]||(n[2]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("text",{class:"modal-title"},"Chèn liên kết"),e.withDirectives(e.createElementVNode("input",{class:"modal-input","onUpdate:modelValue":n[0]||(n[0]=e=>p.value=e),placeholder:"https://example.com",focus:m.value},null,8,["focus"]),[[e.vModelText,p.value]]),e.createElementVNode("view",{class:"modal-actions"},[e.createElementVNode("button",{class:"btn-cancel",onClick:n[1]||(n[1]=e=>m.value=!1)},"Hủy"),e.createElementVNode("button",{class:"btn-confirm",onClick:_},"Xác nhận")])])])):e.createCommentVNode("",!0),g.value?(e.openBlock(),e.createElementBlock("view",{key:1,class:"modal-overlay",onClick:k},[e.createElementVNode("view",{class:"modal-box color-box",onClick:n[7]||(n[7]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("view",{class:"color-tabs"},[e.createElementVNode("view",{class:e.normalizeClass(["color-tab",{active:"color"===f.value}]),onClick:n[4]||(n[4]=e=>f.value="color")}," Màu chữ ",2),e.createElementVNode("view",{class:e.normalizeClass(["color-tab",{active:"backgroundColor"===f.value}]),onClick:n[5]||(n[5]=e=>f.value="backgroundColor")}," Màu nền ",2)]),e.createElementVNode("view",{class:"color-grid"},[e.createElementVNode("view",{class:"color-circle no-color",onClick:n[6]||(n[6]=e=>y(""))},[e.createElementVNode("text",{class:"x-mark"},"✕")]),(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(r,((t,a)=>{return e.createElementVNode("view",{key:a,class:e.normalizeClass(["color-circle",{selected:(n=t,c.value[f.value]===n)}]),style:e.normalizeStyle({backgroundColor:t}),onClick:e=>y(t)},null,14,["onClick"]);var n})),64))])])])):e.createCommentVNode("",!0)]))}}),[["__scopeId","data-v-3e7e1abf"]]),Ae=i(e.defineComponent({__name:"TodoDatePicker",props:{dueDate:{},notifyDate:{},notifyTime:{}},emits:["update:dueDate","update:notifyDate","update:notifyTime","change"],setup(t,{emit:a}){const n=a,o=(e,t)=>{n(`update:${t}`,e.detail.value),setTimeout((()=>{n("change",{field:t,value:e.detail.value})}),50)},l=e=>{if(!e)return"";try{if(e.includes("-")){const[t,a,n]=e.split("-");return`${n}/${a}/${t}`}return e}catch(t){return e}};return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"flat-item date-compound-block"},[e.createElementVNode("view",{class:"right-column"},[e.createElementVNode("view",{class:"date-row"},[e.createElementVNode("picker",{mode:"date",value:t.dueDate,onChange:a[0]||(a[0]=e=>o(e,"dueDate")),onCancel:()=>{},class:"full-width-picker"},[e.createElementVNode("view",{class:e.normalizeClass(["item-picker",{"placeholder-color":!t.dueDate}])},[e.createElementVNode("text",{class:"picker-label"},"Hạn xử lý:"),e.createTextVNode(" "+e.toDisplayString(t.dueDate?l(t.dueDate):"Chọn ngày"),1)],2)],40,["value"])]),e.createElementVNode("view",{class:"inner-divider"}),e.createElementVNode("view",{class:"date-row split-row"},[e.createElementVNode("picker",{mode:"date",value:t.notifyDate,onChange:a[1]||(a[1]=e=>o(e,"notifyDate")),class:"half-picker"},[e.createElementVNode("view",{class:e.normalizeClass(["item-picker",{"placeholder-color":!t.notifyDate}])},[e.createElementVNode("text",{class:"picker-label"},"Ngày thông báo:"),e.createTextVNode(" "+e.toDisplayString(t.notifyDate?l(t.notifyDate):"Ngày"),1)],2)],40,["value"]),e.createElementVNode("view",{class:"vertical-divider"}),e.createElementVNode("picker",{mode:"time",value:t.notifyTime,onChange:a[2]||(a[2]=e=>o(e,"notifyTime")),class:"half-picker"},[e.createElementVNode("view",{class:e.normalizeClass(["item-picker",{"placeholder-color":!t.notifyTime}])},e.toDisplayString(t.notifyTime?t.notifyTime:"Giờ"),3)],40,["value"])])])]))}}),[["__scopeId","data-v-f0c9adc4"]]),Oe=e.defineComponent({__name:"create_todo",setup(t){const{loading:a,form:n,goBack:o,submitForm:l,memberOptions:r,onMemberChange:i,currentAssigneeName:s,showCustomerModal:c,loadingCustomer:d,customerList:u,openCustomerPopup:p,onCustomerSelect:g,sourceOptions:f,sourceIndex:v,onSourceChange:h}=Ie();return(t,y)=>(e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/edit--v1.png",class:"item-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"item-input","onUpdate:modelValue":y[0]||(y[0]=t=>e.unref(n).name=t),placeholder:"Nhập tên công việc *",maxlength:"29"},null,512),[[e.vModelText,e.unref(n).name]])]),e.createVNode(Be,{modelValue:e.unref(n).desc,"onUpdate:modelValue":y[1]||(y[1]=t=>e.unref(n).desc=t)},null,8,["modelValue"]),e.createElementVNode("view",{class:"flat-item",onClick:y[2]||(y[2]=(...t)=>e.unref(p)&&e.unref(p)(...t))},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/price-tag.png",class:"item-icon"})]),e.createElementVNode("view",{class:e.normalizeClass(["input-trigger",{placeholder:!e.unref(n).customer}])},e.toDisplayString(e.unref(n).customer||"Chọn khách hàng"),3),e.createElementVNode("text",{class:"arrow-icon"},"›")]),e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/internet.png",class:"item-icon"})]),e.createElementVNode("picker",{mode:"selector",range:e.unref(f),onChange:y[3]||(y[3]=(...t)=>e.unref(h)&&e.unref(h)(...t)),class:"full-width-picker"},[e.createElementVNode("view",{class:e.normalizeClass(["picker-display",{"placeholder-color":-1===e.unref(v)}])},e.toDisplayString(e.unref(v)>-1?e.unref(f)[e.unref(v)]:"Chọn nguồn"),3)],40,["range"]),e.createElementVNode("text",{class:"arrow-icon"},"›")]),e.createVNode(m,{visible:e.unref(c),loading:e.unref(d),customers:e.unref(u),onClose:y[4]||(y[4]=e=>c.value=!1),onSelect:e.unref(g)},null,8,["visible","loading","customers","onSelect"]),e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/user.png",class:"item-icon"})]),e.createElementVNode("picker",{mode:"selector",range:e.unref(r),onChange:y[5]||(y[5]=(...t)=>e.unref(i)&&e.unref(i)(...t)),class:"full-width-picker"},[e.createElementVNode("view",{class:e.normalizeClass(["picker-display",{"placeholder-color":!e.unref(s)}])},e.toDisplayString(e.unref(s)?e.unref(s):"Người được giao"),3)],40,["range"])]),e.createVNode(Ae,{dueDate:e.unref(n).dueDate,"onUpdate:dueDate":y[6]||(y[6]=t=>e.unref(n).dueDate=t),notifyDate:e.unref(n).notifyDate,"onUpdate:notifyDate":y[7]||(y[7]=t=>e.unref(n).notifyDate=t),notifyTime:e.unref(n).notifyTime,"onUpdate:notifyTime":y[8]||(y[8]=t=>e.unref(n).notifyTime=t)},null,8,["dueDate","notifyDate","notifyTime"]),e.createElementVNode("view",{class:"footer-action"},[e.createVNode(Te,{type:"secondary",label:"Hủy bỏ",class:"btn-cancel",onClick:e.unref(o)},null,8,["onClick"]),e.createVNode(Te,{type:"primary",label:e.unref(a)?"Đang lưu...":"Lưu công việc",loading:e.unref(a),class:"btn-submit",onClick:e.unref(l)},null,8,["label","loading","onClick"])]),e.createVNode(xe)]))}}),$e=e=>{if(!e||e<=0)return"";try{const t=new Date(e),a=t.getFullYear(),n=(t.getMonth()+1).toString().padStart(2,"0");return`${a}-${n}-${t.getDate().toString().padStart(2,"0")}`}catch{return""}},Le=e=>{if(!e||e<=0)return"";try{const t=new Date(e),a=t.getHours().toString().padStart(2,"0");return`${a}:${t.getMinutes().toString().padStart(2,"0")}`}catch{return""}},Me=()=>{const a=te(),n=a.uid,o=e.ref(!1),l=e.ref(!1),i=e.ref(!1),s=e.ref([]),d=e.ref([]),u=e.ref(!1),m=e.ref(""),p=e.ref(!1),g=e.ref(!1),f=e.ref(null),v=e.ref(!1),h=e.ref(""),y=e.ref(!1),k=e.ref(!1),C=e.ref(!1),E=e.ref(null),w=e.ref(""),N=e.ref(!1),V=e.ref(null),b=e.ref(0),T=["","COMMENT"],x=e.ref(!1),D=(e,t="00:00")=>{if(!e)return 0;try{const a=`${e}T${t}:00`;return new Date(a).getTime()}catch{return 0}},S=e.computed((()=>!U.value.raw||"DONE"===U.value.raw.status)),_=()=>{C.value=!1,I()},I=()=>{k.value=!1,E.value=null,w.value="",m.value=""},B=()=>{N.value=!1,V.value=null},A=e.ref(null),F=e.ref(0),R=["ALL","TODO","TICKET","HISTORY_CALL","CUSTOMER","NOTE"],U=e.ref({id:"",title:"",code:"Loading...",desc:"",statusIndex:0,sourceIndex:0,assigneeIndex:0,assigneeId:"",dueDate:"",notifyDate:"",notifyTime:"",customerCode:"",customerName:"",customerNameLabel:"",customerPhone:"",customerPhoneLabel:"",customerManagerName:"",customerManagerLabel:""}),P=e.ref([]),z=e.ref([]),j=e.computed((()=>{const e=[{label:"Chưa xử lý",value:"TO_DO"},{label:"Đang xử lý",value:"IN_PROGRESS"},{label:"Hoàn thành",value:"DONE"}];return U.value.raw&&"IN_PROGRESS"===U.value.raw.status?e.filter((e=>"TO_DO"!==e.value)):e})),H=e.computed((()=>j.value.map((e=>e.label)))),G=()=>{v.value=!1,A.value=null,m.value="",h.value=""};r((async e=>{await q(),e&&e.id&&await W(e.id)}));const q=async()=>{try{const e=await he();P.value=e,z.value=e.map((e=>e.UserName||"Thành viên ẩn danh"))}catch(e){t("error","at controllers/todo_detail.ts:562","Lỗi lấy members",e)}},W=async e=>{o.value=!0;try{const t=await(e=>ae({url:`${X}/getDetail`,method:"GET",data:{id:e,projectCode:J}}))(e),a=(e=>{if(!e)return null;let t=[ne,oe,le].indexOf(e.status);-1===t&&(t=0);let a=[O,$,L,M].indexOf(e.links);-1===a&&(a=0);const n=e.notificationReceivedAt||0;return{id:e.id,title:e.title||"",code:e.code||"",desc:e.description||"",statusIndex:t,sourceIndex:a,assigneeIndex:0,assigneeId:e.assigneeId||"",dueDate:$e(e.dueDate),notifyDate:$e(n),notifyTime:Le(n),customerCode:e.customerCode||"",customerName:"",customerNameLabel:"Tên khách hàng",customerPhone:"",customerPhoneLabel:"Số điện thoại",customerManagerName:"",raw:e}})(t&&t.data&&!t.id?t.data:t);if(a){U.value=a;const t=a.raw.status,n=j.value.findIndex((e=>e.value===t));if(-1!==n&&(U.value.statusIndex=n),Z(e),U.value.assigneeId&&P.value.length>0){const e=P.value.findIndex((e=>e.memberUID===U.value.assigneeId));-1!==e&&(U.value.assigneeIndex=e)}U.value.customerCode&&(await ee(U.value.customerCode),re(U.value.customerCode))}}catch(a){t("error","at controllers/todo_detail.ts:596"," Lỗi lấy chi tiết:",a),Ce("Lỗi kết nối")}finally{o.value=!1}},Q=e=>{var t;let a="Người dùng ẩn",n="?",o="#e3f2fd";if(e.senderId){const t=P.value.find((t=>t.UID===e.senderId||t.memberUID===e.senderId));t&&(a=t.UserName,t.AvatarColor&&(o=t.AvatarColor))}n=a.charAt(0).toUpperCase();let l="";"COMMENT"===e.type?l="đã thêm một bình luận":"LOG"===e.type?l="đã cập nhật hoạt động":"UPDATE_TODO"===e.type&&(l="cập nhật thông tin công việc");const r=(null==(t=e.reactions)?void 0:t.details)||[];return{id:e.id,senderId:e.senderId,senderName:a,senderAvatarChar:n,senderAvatarColor:o,message:e.message||"",timeDisplay:c(e.createdAt),actionText:l,isEdited:!!e.updatedAt,type:e.type,reactions:r,children:[]}},Z=async e=>{u.value=!0;try{const t=T[b.value],a=await((e,t="")=>ae({url:`${K}/api/module-todo/todoMessages/getAllNoPageWithReact`,method:"GET",data:{todoId:e,keySearch:t}}))(e,t);Array.isArray(a)?d.value=a.map((e=>{const t=Q(e);return e.replies&&e.replies.length>0&&(t.children=e.replies.map((e=>Q(e)))),t})):d.value=[]}catch(a){t("error","at controllers/todo_detail.ts:666","Lỗi lấy bình luận:",a)}finally{u.value=!1}},ee=async e=>{var n;l.value=!0;try{const t=a.todoToken;if(!t)return;const o=await((e,t)=>ae({url:`${Y}/Customer/getDetail`,method:"GET",data:{uid:t},header:{Authorization:`Bearer ${e}`}}))(t,e),r=o.fields||(null==(n=o.data)?void 0:n.fields)||[],i=r.find((e=>"name"===e.code)),s=r.find((e=>"phone"===e.code)),c=r.find((e=>"member_no"===e.code));if(i&&(U.value.customerName=i.value,U.value.customerNameLabel=i.name),s&&(U.value.customerPhone=s.value,U.value.customerPhoneLabel=s.name),c){U.value.customerManagerLabel=c.name;const e=c.value,t=P.value.find((t=>t.memberUID===e));U.value.customerManagerName=t?t.UserName:"(Chưa xác định)"}}catch(o){t("error","at controllers/todo_detail.ts:723","Lỗi CRM:",o)}finally{l.value=!1}},re=async e=>{i.value=!0;try{const n=R[F.value],o=a.todoToken;if(!o)return void t("error","at controllers/todo_detail.ts:735","Chưa có Token CRM/Todo");const l=await((e,t,a="ALL")=>ae({url:`${Y}/ActionTimeline/getAll?from=-1&to=-1&customerUid=${t}&type=${a}&page=1&size=10&memberUid=&projectCode=`,method:"GET",header:{Authorization:`Bearer ${e}`}}))(o,e,n);Array.isArray(l)&&(s.value=l.map((e=>{const t=new Date(e.createAt),a=`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()}`;let n="Hệ thống";if(e.memberUid){const t=P.value.find((t=>t.memberUID===e.memberUid));t&&(n=t.UserName)}const o=se[e.typeSub]||e.typeSub||"Tương tác khác";return{id:e.id,timeStr:a,content:o,actorName:n,originalType:e.typeSub}})))}catch(n){t("error","at controllers/todo_detail.ts:773","Lỗi lấy lịch sử:",n)}finally{i.value=!1}};return{isLoading:o,isLoadingCustomer:l,isLoadingHistory:i,historyList:s,form:U,statusOptions:H,sourceOptions:["Cuộc gọi","Khách hàng","Hội thoại","Tin nhắn"],assigneeOptions:z,onStatusChange:async e=>{const a=parseInt(e.detail.value),n=j.value[a];if(!n)return;U.value.statusIndex=a;const o=n.value;if(U.value.raw){we("Đang cập nhật...");try{const e={...U.value.raw,status:o,preFixCode:"TODO",description:U.value.desc,files:"",tagCodes:"",title:U.value.title||U.value.raw.title};t("log","at controllers/todo_detail.ts:820","Payload Update Status:",e);if(await ge(e)){ke("Đã cập nhật trạng thái"),U.value.raw.status=o;const e=j.value.findIndex((e=>e.value===o));U.value.statusIndex=-1!==e?e:0,U.value.customerCode&&await re(U.value.customerCode),await Z(U.value.id)}}catch(l){t("error","at controllers/todo_detail.ts:836","Lỗi cập nhật trạng thái:",l),Ce("Lỗi cập nhật")}finally{uni.hideLoading()}}},onSourceChange:e=>{U.value.sourceIndex=e.detail.value},onAssigneeChange:async e=>{const a=parseInt(e.detail.value);if(!P.value[a])return;const n=P.value[a].memberUID;if(U.value.assigneeIndex=a,U.value.assigneeId=n,U.value.raw){we("Đang cập nhật người giao...");try{const e={...U.value.raw,assigneeId:n,preFixCode:"TODO",description:U.value.desc,files:"",tagCodes:"",title:U.value.title||U.value.raw.title};t("log","at controllers/todo_detail.ts:879","Payload Update Assignee:",e);await ge(e)&&(ke("Đã đổi người thực hiện"),U.value.raw.assigneeId=n,U.value.customerCode&&await re(U.value.customerCode),await Z(U.value.id))}catch(o){t("error","at controllers/todo_detail.ts:897","Lỗi cập nhật người giao:",o),Ce("Lỗi cập nhật")}finally{Ne()}}else Ce("Thiếu dữ liệu gốc")},goBack:()=>{uni.navigateBack()},saveTodo:()=>{t("log","at controllers/todo_detail.ts:905","Lưu:",U.value),ke("Đã lưu")},historyFilterOptions:["Tất cả","Công việc","Ticket","Lịch sử gọi","Khách hàng","Ghi chú"],historyFilterIndex:F,onHistoryFilterChange:e=>{F.value=e.detail.value,U.value.customerCode&&re(U.value.customerCode)},comments:d,isLoadingComments:u,newCommentText:m,isSubmittingComment:p,submitComment:async()=>{if(m.value&&m.value.trim()){p.value=!0;try{const e=U.value.id,n={todoId:e,senderId:a.uid,message:m.value,files:"",parentId:-1};t("log","at controllers/todo_detail.ts:525","Đang gửi bình luận:",n);await fe(n)&&(ke("Đã gửi bình luận"),m.value="",await Z(e))}catch(e){t("error","at controllers/todo_detail.ts:540","Lỗi gửi bình luận:",e),Ce("Gửi thất bại")}finally{p.value=!1}}else Ee("Vui lòng nhập nội dung")},isConfirmDeleteCommentOpen:g,onRequestDeleteComment:e=>{f.value=e,g.value=!0},confirmDeleteComment:async()=>{if(f.value){g.value=!1;try{await(e=f.value,ae({url:`${K}/api/module-todo/todoMessages/delete`,method:"POST",data:{id:e}})),ke("Đã xóa"),U.value.id&&await Z(U.value.id)}catch(a){t("error","at controllers/todo_detail.ts:490","Lỗi xóa bình luận:",a),Ce("Xóa thất bại")}finally{f.value=null}var e}},cancelDeleteComment:()=>{g.value=!1,f.value=null},currentUserId:n,isEditingComment:v,onRequestEditComment:async a=>{const n=U.value.id;if(n){we("Đang tải...");try{const o=await((e,t)=>ae({url:`${K}/api/module-todo/todoMessages/getDetail`,method:"GET",data:{id:e,todoId:t}}))(a,n);if(t("log","at controllers/todo_detail.ts:363","API Response Detail:",o),o){const a=o.data||o;A.value={id:a.id,todoId:a.todoId,senderId:a.senderId};const n=a.senderId,l=P.value.find((e=>e.UID===n));h.value=l?l.UserName:"tôi";const r=a.message||"";t("log","at controllers/todo_detail.ts:389","Nội dung edit:",r),v.value=!0,await e.nextTick(),m.value=r}}catch(o){t("error","at controllers/todo_detail.ts:400","Lỗi lấy chi tiết bình luận:",o),Ce("Lỗi tải dữ liệu")}finally{uni.hideLoading()}}},submitUpdateComment:async()=>{if(A.value)if(m.value&&m.value.trim()){p.value=!0;try{const a={id:A.value.id,todoId:A.value.todoId,senderId:A.value.senderId,message:m.value,files:""};t("log","at controllers/todo_detail.ts:426","Payload Update:",a),await(e=a,ae({url:`${K}/api/module-todo/todoMessages/update`,method:"POST",data:e})),ke("Đã cập nhật"),G(),await Z(U.value.id)}catch(a){t("error","at controllers/todo_detail.ts:437","Lỗi cập nhật:",a),Ce("Cập nhật thất bại")}finally{p.value=!1}var e}else Ee("Nội dung không được để trống")},onCancelEditComment:()=>{y.value=!0},isConfirmCancelEditOpen:y,continueEditing:()=>{y.value=!1},confirmCancelEdit:async()=>{y.value=!1,G(),U.value.id&&await Z(U.value.id)},editingMemberName:h,isEmojiPickerOpen:N,emojiList:["👍","👎","😍","😆","😱","😭","😤"],onToggleEmojiPicker:e=>{V.value=e,N.value=!0},closeEmojiPicker:B,selectEmoji:async e=>{if(!V.value)return;const n=V.value.id;B();const o=U.value.id,l=a.uid,r={todoId:Number(o),senderId:l,todoMessageId:Number(n),codeEmoji:e};t("log","at controllers/todo_detail.ts:285",">> Gửi Reaction:",r);try{await(i=r,ae({url:`${K}/api/module-todo/todoMessages/reaction`,method:"POST",data:i}))&&(ke("Đã thả cảm xúc"),await Z(o))}catch(s){t("error","at controllers/todo_detail.ts:296","Lỗi thả cảm xúc:",s),Ce("Lỗi kết nối")}var i},isReplying:k,isConfirmCancelReplyOpen:C,replyingCommentData:E,replyingMemberName:w,onRequestReply:async t=>{v.value=!1,A.value=null,m.value="",E.value=t,k.value=!0;const a=t.senderId,n=P.value.find((e=>e.UID===a));w.value=n?n.UserName:"Người dùng ẩn",await e.nextTick()},onCancelReply:()=>{m.value.trim()?C.value=!0:_()},confirmCancelReply:_,continueReplying:()=>{C.value=!1},submitReply:async()=>{if(m.value&&m.value.trim()){if(E.value){p.value=!0;try{const e=U.value.id,n={todoId:e,senderId:a.uid,message:m.value,files:"",parentId:E.value.id};t("log","at controllers/todo_detail.ts:234",">> Gửi trả lời:",n);await fe(n)&&(ke("Đã trả lời"),I(),await Z(e))}catch(e){t("error","at controllers/todo_detail.ts:244","Lỗi gửi trả lời:",e),Ce("Gửi thất bại")}finally{p.value=!1}}}else Ee("Vui lòng nhập nội dung")},commentFilterIndex:b,commentFilterOptions:["Tất cả hoạt động","Bình luận"],onCommentFilterChange:e=>{const t=e.detail.value;b.value!==t&&(b.value=t,U.value.id&&Z(U.value.id))},isSavingDescription:x,onSaveDescription:async()=>{if(U.value.raw){x.value=!0;try{const e={...U.value.raw,preFixCode:"TODO",description:U.value.desc,files:"",tagCodes:"",title:U.value.title||U.value.raw.title};t("log","at controllers/todo_detail.ts:159","Payload Update Todo:",e);await ge(e)&&ke("Đã cập nhật mô tả")}catch(e){t("error","at controllers/todo_detail.ts:167","Lỗi cập nhật công việc:",e),Ce("Cập nhật thất bại")}finally{x.value=!1}}else Ce("Không tìm thấy dữ liệu gốc")},onDateUpdate:async e=>{if(U.value.raw){we("Đang cập nhật...");try{const a={...U.value.raw,preFixCode:"TODO",description:U.value.desc,files:"",tagCodes:"",title:U.value.title||U.value.raw.title};if("dueDate"===e.field)a.dueDate=D(e.value,"23:59");else if("notifyDate"===e.field||"notifyTime"===e.field){const t="notifyDate"===e.field?e.value:U.value.notifyDate,n="notifyTime"===e.field?e.value:U.value.notifyTime;t&&n&&(a.notificationReceivedAt=D(t,n))}t("log","at controllers/todo_detail.ts:114",`Payload Update ${e.field}:`,a);await ge(a)&&(ke("Cập nhật thành công"),"dueDate"===e.field?U.value.raw.dueDate=a.dueDate:U.value.raw.notificationReceivedAt=a.notificationReceivedAt,U.value.customerCode&&await re(U.value.customerCode),await Z(U.value.id))}catch(a){t("error","at controllers/todo_detail.ts:132","Lỗi cập nhật ngày:",a),Ce("Lỗi cập nhật")}finally{Ne()}}},isStatusDisabled:S,dynamicStatusOptions:j}},Fe=i(e.defineComponent({__name:"CommentItem",props:{data:{},isReply:{type:Boolean}},emits:["react","reply","edit","delete"],setup(t,{emit:a}){const n=t,o=te(),l=e.computed((()=>String(n.data.senderId)===String(o.uid)));return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"comment-thread"},[e.createElementVNode("view",{class:"flex gap-3 mb-4 items-start"},[e.createVNode(s,{name:t.data.senderName,"avatar-color":t.data.senderAvatarColor,size:t.isReply?30:40,class:e.normalizeClass(["shrink-0",t.isReply?"mr-2":"mr-3"])},null,8,["name","avatar-color","size","class"]),e.createElementVNode("view",{class:"flex-1 overflow-hidden"},[e.createElementVNode("view",{class:"bg-gray-50 rounded-2xl p-3 rounded-tl-none relative"},[e.createElementVNode("view",{class:"flex justify-between items-start mb-1"},[e.createElementVNode("text",{class:"font-bold text-sm text-gray-900"},e.toDisplayString(t.data.senderName),1),e.createElementVNode("view",{class:"flex items-center"},[e.createElementVNode("text",{class:"text-xs text-gray-400"},e.toDisplayString(t.data.timeDisplay),1),t.data.isEdited?(e.openBlock(),e.createElementBlock("text",{key:0,class:"text-xs text-gray-400 italic ml-1"},"• Đã sửa")):e.createCommentVNode("",!0)])]),e.createElementVNode("rich-text",{nodes:t.data.message,class:"text-sm text-gray-700 leading-normal"},null,8,["nodes"])]),e.createElementVNode("view",{class:"c-footer-actions"},[e.createElementVNode("view",{class:"reaction-row"},[t.data.reactions&&t.data.reactions.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"flex gap-1 mt-1"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.data.reactions,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"emoji-tag"},e.toDisplayString(t.codeEmoji),1)))),128))])):e.createCommentVNode("",!0)]),"UPDATE_TODO"!==t.data.type?(e.openBlock(),e.createElementBlock("view",{key:0,class:"action-buttons-container"},[e.createElementVNode("view",{class:"btn-icon-action",onClick:a[0]||(a[0]=e=>t.$emit("react",t.data))},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/999999/happy--v1.png",class:"icon-action"})]),e.createElementVNode("view",{class:"btn-icon-action",onClick:a[1]||(a[1]=e=>t.$emit("reply",t.data))},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/999999/speech-bubble--v1.png",class:"icon-action"})]),l.value?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createElementVNode("view",{class:"btn-icon-action",onClick:a[2]||(a[2]=e=>t.$emit("edit",t.data))},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/999999/create-new.png",class:"icon-action"})]),e.createElementVNode("view",{class:"btn-icon-action",onClick:a[3]||(a[3]=e=>t.$emit("delete",t.data.id))},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/999999/trash--v1.png",class:"icon-action"})])],64)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)])])]),t.data.children&&t.data.children.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pl-12 mt-2 replies-wrapper"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.data.children,(n=>(e.openBlock(),e.createBlock(Fe,{key:n.id,data:n,"is-reply":!0,onReact:a[4]||(a[4]=e=>t.$emit("react",e)),onReply:a[5]||(a[5]=e=>t.$emit("reply",e)),onEdit:a[6]||(a[6]=e=>t.$emit("edit",e)),onDelete:a[7]||(a[7]=e=>t.$emit("delete",e))},null,8,["data"])))),128))])):e.createCommentVNode("",!0)]))}}),[["__scopeId","data-v-a25d3cf1"]]),Re=i(e.defineComponent({__name:"todo_detail",setup(t){const{isLoading:a,isLoadingCustomer:n,isLoadingHistory:o,historyList:l,form:r,statusOptions:i,sourceOptions:s,assigneeOptions:c,onStatusChange:d,onSourceChange:u,onAssigneeChange:m,saveTodo:p,historyFilterOptions:g,historyFilterIndex:f,onHistoryFilterChange:v,comments:h,isLoadingComments:y,newCommentText:k,isSubmittingComment:C,submitComment:E,isConfirmDeleteCommentOpen:w,onRequestDeleteComment:N,confirmDeleteComment:V,cancelDeleteComment:b,currentUserId:T,isEditingComment:x,onRequestEditComment:D,submitUpdateComment:S,onCancelEditComment:_,isConfirmCancelEditOpen:I,continueEditing:B,confirmCancelEdit:A,editingMemberName:O,isEmojiPickerOpen:$,emojiList:L,onToggleEmojiPicker:M,closeEmojiPicker:F,selectEmoji:R,isReplying:U,replyingMemberName:P,replyingCommentData:z,onRequestReply:j,onCancelReply:H,submitReply:G,isConfirmCancelReplyOpen:q,continueReplying:K,confirmCancelReply:Y,commentFilterIndex:W,commentFilterOptions:X,onCommentFilterChange:J,isSavingDescription:Q,onSaveDescription:Z,onDateUpdate:ee,isStatusDisabled:te}=Me(),ae=e.ref(!1),ne=()=>{ae.value=!ae.value};return(t,u)=>(e.openBlock(),e.createElementBlock("view",{class:"container"},[e.unref(a)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-overlay"},[e.createElementVNode("text",null,"Đang tải...")])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"detail-header"},[e.createElementVNode("view",{class:"header-top"},[e.createElementVNode("text",{class:"header-code"},"#"+e.toDisplayString(e.unref(r).code),1)]),e.withDirectives(e.createElementVNode("input",{class:"header-title-input","onUpdate:modelValue":u[0]||(u[0]=t=>e.unref(r).title=t),placeholder:"Tên công việc"},null,512),[[e.vModelText,e.unref(r).title]])]),e.createElementVNode("scroll-view",{"scroll-y":"true",class:"detail-body"},[e.createElementVNode("view",{class:"section-title"},"Mô tả"),e.createElementVNode("view",{class:"section-block"},[e.createVNode(Be,{modelValue:e.unref(r).desc,"onUpdate:modelValue":u[1]||(u[1]=t=>e.unref(r).desc=t),placeholder:"Nhập mô tả công việc..."},null,8,["modelValue"]),e.createElementVNode("view",{class:"input-actions",style:{"margin-top":"10px"}},[e.createVNode(Te,{type:"primary",size:"small",loading:e.unref(Q),label:e.unref(Q)?"Đang lưu...":"Lưu lại",onClick:e.unref(Z)},null,8,["loading","label","onClick"])])]),e.createElementVNode("view",{class:"section-title"},"Thông tin công việc"),e.createElementVNode("view",{class:"info-group"},[e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/checked-checkbox.png",class:"item-icon"}),e.createElementVNode("text",{class:"item-label"},"Trạng thái")]),e.createElementVNode("picker",{mode:"selector",range:e.unref(i),value:e.unref(r).statusIndex,disabled:e.unref(te),onChange:u[2]||(u[2]=(...t)=>e.unref(d)&&e.unref(d)(...t)),class:"item-picker-box"},[e.createElementVNode("view",{class:e.normalizeClass(["picker-text",{"disabled-text":e.unref(te)}])},[e.createTextVNode(e.toDisplayString(e.unref(i)[e.unref(r).statusIndex])+" ",1),e.unref(te)?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("text",{key:0},"▾"))],2)],40,["range","value","disabled"])]),e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/internet.png",class:"item-icon"}),e.createElementVNode("text",{class:"item-label"},"Nguồn")]),e.createElementVNode("view",{class:"item-picker-box"},[e.createElementVNode("view",{class:"picker-text disabled-text"},e.toDisplayString(e.unref(s)[e.unref(r).sourceIndex]||"Không xác định"),1)])]),e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/user.png",class:"item-icon"}),e.createElementVNode("text",{class:"item-label"},"Người được giao")]),e.createElementVNode("picker",{mode:"selector",range:e.unref(c),value:e.unref(r).assigneeIndex,onChange:u[3]||(u[3]=(...t)=>e.unref(m)&&e.unref(m)(...t)),class:"item-picker-box"},[e.createElementVNode("view",{class:"picker-text"},e.toDisplayString(e.unref(r).assigneeIndex>-1&&e.unref(c)[e.unref(r).assigneeIndex]?e.unref(c)[e.unref(r).assigneeIndex]:"Chọn người giao")+" ▾ ",1)],40,["range","value"])]),e.createVNode(Ae,{dueDate:e.unref(r).dueDate,"onUpdate:dueDate":u[4]||(u[4]=t=>e.unref(r).dueDate=t),notifyDate:e.unref(r).notifyDate,"onUpdate:notifyDate":u[5]||(u[5]=t=>e.unref(r).notifyDate=t),notifyTime:e.unref(r).notifyTime,"onUpdate:notifyTime":u[6]||(u[6]=t=>e.unref(r).notifyTime=t),onChange:e.unref(ee)},null,8,["dueDate","notifyDate","notifyTime","onChange"])]),e.createElementVNode("view",{class:"section-title"},"Thông tin khách hàng"),e.createElementVNode("view",{class:"info-group customer-block"},[e.unref(n)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-row"},[e.createElementVNode("text",{class:"loading-text"},"Đang tải thông tin từ CRM...")])):e.unref(r).customerCode?(e.openBlock(),e.createElementBlock("view",{key:2},[e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/user-male-circle.png",class:"item-icon"}),e.createElementVNode("text",{class:"item-label"},e.toDisplayString(e.unref(r).customerNameLabel),1)]),e.createElementVNode("view",{class:"item-right-text"},e.toDisplayString(e.unref(r).customerName),1)]),e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/phone.png",class:"item-icon"}),e.createElementVNode("text",{class:"item-label"},e.toDisplayString(e.unref(r).customerPhoneLabel),1)]),e.createElementVNode("view",{class:"item-right-text phone-text"},e.toDisplayString(e.unref(r).customerPhone),1)]),e.createElementVNode("view",{class:"flat-item"},[e.createElementVNode("view",{class:"item-left"},[e.createElementVNode("image",{src:"https://img.icons8.com/ios/50/666666/manager.png",class:"item-icon"}),e.createElementVNode("text",{class:"item-label"},e.toDisplayString(e.unref(r).customerManagerLabel),1)]),e.createElementVNode("view",{class:"item-right-text highlight-text"},e.toDisplayString(e.unref(r).customerManagerName||"(Chưa có)"),1)])])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-row"},[e.createElementVNode("text",null,"(Công việc này chưa gắn với khách hàng nào)")]))]),e.createElementVNode("view",{class:"section-header-row"},[e.createElementVNode("view",{class:"toggle-header",onClick:ne},[e.createElementVNode("text",{class:"section-title no-margin"},"Bình luận và hoạt động"),e.createElementVNode("image",{src:"https://img.icons8.com/ios-glyphs/30/666666/expand-arrow--v1.png",class:e.normalizeClass(["toggle-icon",{open:ae.value}])},null,2)]),e.createElementVNode("picker",{mode:"selector",range:e.unref(X),value:e.unref(W),onClick:u[7]||(u[7]=e.withModifiers((()=>{}),["stop"])),onChange:u[8]||(u[8]=(...t)=>e.unref(J)&&e.unref(J)(...t))},[e.createElementVNode("view",{class:"filter-badge"},e.toDisplayString(e.unref(X)[e.unref(W)])+" ▾ ",1)],40,["range","value"])]),ae.value?(e.openBlock(),e.createElementBlock("view",{key:0,class:"comments-section"},[e.createElementVNode("view",{class:"comment-input-block"},[e.createElementVNode("view",{class:"editor-container"},[e.createVNode(Be,{modelValue:e.unref(k),"onUpdate:modelValue":u[9]||(u[9]=t=>e.isRef(k)?k.value=t:null),placeholder:e.unref(x)?"Đang chỉnh sửa...":e.unref(U)?"Viết câu trả lời...":"Viết bình luận"},null,8,["modelValue","placeholder"])]),e.unref(x)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"editing-alert"},[e.createElementVNode("text",{class:"editing-text"},[e.createTextVNode(" Đang chỉnh sửa bình luận của "),e.createElementVNode("text",{class:"editing-name"},e.toDisplayString(e.unref(O)),1)])])):e.createCommentVNode("",!0),e.unref(U)&&e.unref(z)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"reply-alert"},[e.createElementVNode("view",{class:"reply-info"},[e.createElementVNode("text",{class:"reply-label"},"Đang trả lời bình luận của "),e.createElementVNode("text",{class:"reply-name"},e.toDisplayString(e.unref(P)),1)]),e.createElementVNode("view",{class:"reply-quote"},[e.createElementVNode("text",{class:"quote-icon"},"“"),e.createElementVNode("rich-text",{nodes:e.unref(z).message,class:"quote-content"},null,8,["nodes"]),e.createElementVNode("text",{class:"quote-icon"},"”")])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"input-actions"},[e.unref(x)||e.unref(U)?e.unref(x)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"edit-actions-row"},[e.createVNode(Te,{type:"secondary",size:"small",label:"Hủy",disabled:e.unref(C),onClick:e.unref(_)},null,8,["disabled","onClick"]),e.createVNode(Te,{type:"primary",size:"small",loading:e.unref(C),label:e.unref(C)?"Đang cập nhật...":"Cập nhật",onClick:e.unref(S)},null,8,["loading","label","onClick"])])):e.unref(U)?(e.openBlock(),e.createElementBlock("view",{key:2,class:"edit-actions-row"},[e.createVNode(Te,{type:"secondary",size:"small",label:"Hủy",disabled:e.unref(C),onClick:e.unref(H)},null,8,["disabled","onClick"]),e.createVNode(Te,{type:"primary",size:"small",loading:e.unref(C),label:e.unref(C)?"Đang gửi...":"Trả lời",onClick:e.unref(G)},null,8,["loading","label","onClick"])])):e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(Te,{key:0,type:"primary",size:"small",loading:e.unref(C),label:e.unref(C)?"Đang lưu...":"Lưu lại",onClick:e.unref(E)},null,8,["loading","label","onClick"]))])]),e.createElementVNode("view",{class:"divider-line"}),e.unref(y)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-row"},[e.createElementVNode("text",null,"Đang tải bình luận...")])):0===e.unref(h).length?(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-row"},[e.createElementVNode("text",null,"Chưa có bình luận nào.")])):(e.openBlock(),e.createElementBlock("view",{key:2},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(h),(t=>(e.openBlock(),e.createBlock(Fe,{key:t.id,data:t,onReact:e.unref(M),onReply:e.unref(j),onEdit:u[10]||(u[10]=t=>e.unref(D)(t.id)),onDelete:u[11]||(u[11]=t=>e.unref(N)(t))},null,8,["data","onReact","onReply"])))),128))]))])):e.createCommentVNode("",!0),e.createVNode(De,{visible:e.unref(I),"onUpdate:visible":u[12]||(u[12]=t=>e.isRef(I)?I.value=t:null),title:"Xác nhận hủy",message:"Bạn có chắc muốn hủy chỉnh sửa? Các thay đổi sẽ không được lưu.","cancel-label":"Tiếp tục sửa","confirm-label":"Hủy bỏ","confirm-type":"danger",onCancel:e.unref(B),onConfirm:e.unref(A)},null,8,["visible","onCancel","onConfirm"]),e.createElementVNode("view",{class:"section-header-row"},[e.createElementVNode("text",{class:"section-title no-margin"},"Lịch sử tương tác"),e.createElementVNode("picker",{mode:"selector",range:e.unref(g),value:e.unref(f),onChange:u[13]||(u[13]=(...t)=>e.unref(v)&&e.unref(v)(...t))},[e.createElementVNode("view",{class:"filter-badge"},e.toDisplayString(e.unref(g)[e.unref(f)])+" ▾ ",1)],40,["range","value"])]),e.createElementVNode("view",{class:"history-container"},[e.unref(o)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-row"},[e.createElementVNode("text",{class:"loading-text"},"Đang tải lịch sử...")])):0===e.unref(l).length?(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-row"},[e.createElementVNode("text",null,"(Không tìm thấy dữ liệu)")])):(e.openBlock(),e.createElementBlock("view",{key:2,class:"timeline-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(l),((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:"timeline-item"},[a!==e.unref(l).length-1?(e.openBlock(),e.createElementBlock("view",{key:0,class:"timeline-line"})):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"timeline-dot"}),e.createElementVNode("view",{class:"timeline-content"},[e.createElementVNode("view",{class:"timeline-header"},[e.createElementVNode("text",{class:"t-actor"},e.toDisplayString(t.actorName),1),e.createElementVNode("text",{class:"t-time"},e.toDisplayString(t.timeStr),1)]),e.createElementVNode("text",{class:"t-action"},e.toDisplayString(t.content),1)])])))),128))]))]),e.createElementVNode("view",{style:{height:"50px"}})]),e.createVNode(De,{visible:e.unref(w),"onUpdate:visible":u[14]||(u[14]=t=>e.isRef(w)?w.value=t:null),title:"Xác nhận xóa",message:"Bạn có chắc muốn xóa bình luận này không?","confirm-type":"danger",onConfirm:e.unref(V),onCancel:e.unref(b)},null,8,["visible","onConfirm","onCancel"]),e.unref($)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"modal-overlay",onClick:u[16]||(u[16]=(...t)=>e.unref(F)&&e.unref(F)(...t))},[e.createElementVNode("view",{class:"emoji-picker-container",onClick:u[15]||(u[15]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("view",{class:"emoji-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(L),((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"emoji-item",onClick:a=>e.unref(R)(t)},e.toDisplayString(t),9,["onClick"])))),128))])])])):e.createCommentVNode("",!0),e.createVNode(xe)]))}}),[["__scopeId","data-v-7b18745f"]]);__definePage("pages/todo/list_todo",Se),__definePage("pages/todo/create_todo",Oe),__definePage("pages/todo/todo_detail",Re);const Ue=e.defineComponent({__name:"App",setup:e=>(l((e=>{t("log","at App.vue:6","App Launch");te().initialize(e)})),n((()=>{t("log","at App.vue:13","App Show")})),o((()=>{t("log","at App.vue:17","App Hide")})),()=>{})});const{app:Pe,Vuex:ze,Pinia:je}=function(){const t=e.createVueApp(Ue);return t.use(C()),{app:t,Pinia:A}}();uni.Vuex=ze,uni.Pinia=je,Pe.provide("__globalStyles",__uniConfig.styles),Pe._component.mpType="app",Pe._component.render=()=>{},Pe.mount("#app")}(Vue);
